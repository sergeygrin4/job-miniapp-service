<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вакансии</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
        }

        header {
            background: #fff;
            padding: 10px 0;
            text-align: center;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        #settings-gear {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.75;
            user-select: none;
        }

        #settings-gear:hover {
            opacity: 1;
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background: #fff;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            background: #eee;
            border-radius: 6px;
        }

        .tab.active {
            background: #007bff;
            color: white;
        }

        .container {
            padding: 20px;
        }

        .job {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .group-row {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-url-input {
            width: 75%;
            padding: 8px;
        }

        .group-enable-btn {
            padding: 8px 12px;
            cursor: pointer;
        }

        .tg-admin-row {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .tg-admin-row input {
            flex: 1;
            padding: 8px;
        }

        .tg-admin-row button {
            padding: 8px 14px;
        }
    </style>

</head>
<body>

<header>
    <h1>Поиск вакансий</h1>

    <!-- ШЕСТЕРЁНКА ДЛЯ НАСТРОЕК -->
    <div id="settings-gear" onclick="switchTab('settings')" title="Настройки">
        ⚙️
    </div>
</header>

<nav>
    <button class="tab active" id="jobs-tab-btn" onclick="switchTab('jobs')">Активные вакансии</button>
    <button class="tab" id="archive-tab-btn" onclick="switchTab('archive')">Архив</button>
    <button class="tab" id="channels-tab-btn" onclick="switchTab('channels')">Telegram</button>
    <button class="tab" id="fbgroups-tab-btn" onclick="switchTab('fbgroups')">Facebook</button>

    <!-- Вкладка Настройки (скрывается для юзеров) -->
    <button class="tab" id="settings-tab-btn" onclick="switchTab('settings')">Настройки</button>
</nav>

<div class="container">

    <!-- TAB 1 — АКТИВНЫЕ ВАКАНСИИ -->
    <div id="jobs-tab">
        <div id="jobs-list"></div>
    </div>

    <!-- TAB 2 — АРХИВ -->
    <div id="archive-tab" class="hidden">
        <div id="archive-list"></div>
    </div>

    <!-- TAB 3 — ТЕЛЕГРАМ-КАНАЛЫ -->
    <div id="channels-tab" class="hidden">
        <h3>Telegram каналы</h3>

        <div id="channels-list"></div>

        <div class="tg-admin-row">
            <input type="text" id="new-channel" placeholder="https://t.me/...">
            <button onclick="addChannel()">Добавить</button>
        </div>
    </div>

    <!-- TAB 4 — FACEBOOK ГРУППЫ -->
    <div id="fbgroups-tab" class="hidden">
        <h3>Facebook группы</h3>

        <div id="fb-groups-list"></div>

        <div class="tg-admin-row">
            <input type="text" id="new-fb-group" placeholder="https://www.facebook.com/groups/...">
            <button onclick="addFbGroup()">Добавить</button>
        </div>
    </div>

    <!-- TAB 5 — НАСТРОЙКИ -->
    <div id="settings-tab" class="hidden">
        <h3>Управление доступом</h3>

        <div id="admin-list"></div>

        <div class="tg-admin-row">
            <input type="text" id="new-admin" placeholder="Telegram ID пользователя">
            <button onclick="addAdmin()">Добавить</button>
        </div>

    </div>

</div>

<script>
const API_BASE = window.location.origin;

// ----------------------
// ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК
// ----------------------
function switchTab(tab) {
    document.querySelectorAll(".tab").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll(".container > div").forEach(div => div.classList.add("hidden"));

    document.getElementById(`${tab}-tab-btn`).classList.add("active");
    document.getElementById(`${tab}-tab`).classList.remove("hidden");

    if (tab === "jobs") loadJobs();
    if (tab === "archive") loadArchive();
    if (tab === "channels") loadChannels();
    if (tab === "fbgroups") loadFbGroups();
    if (tab === "settings") loadAdmins();
}

// ----------------------
// ПРОВЕРКА ДОСТУПА
// ----------------------
async function initApp() {
    const res = await fetch(`${API_BASE}/api/check_access`, {method: "POST"});
    const data = await res.json();

    const isAdmin = data.is_admin;

    const settingsTabBtn = document.getElementById("settings-tab-btn");
    const settingsTabDiv = document.getElementById("settings-tab");
    const settingsGear = document.getElementById("settings-gear");

    if (!isAdmin) {
        if (settingsTabBtn) settingsTabBtn.style.display = "none";
        if (settingsTabDiv) settingsTabDiv.style.display = "none";
        if (settingsGear) settingsGear.style.display = "none";
    }

    loadJobs();
}

// ----------------------
// ЗАГРУЗКА ВАКАНСИЙ
// ----------------------
async function loadJobs() {
    const res = await fetch(`${API_BASE}/api/jobs?limit=50`);
    const data = await res.json();

    const list = document.getElementById("jobs-list");
    list.innerHTML = "";

    data.forEach(job => {
        list.innerHTML += `
            <div class="job">
                <div>${job.text}</div>
                <a href="${job.url}" target="_blank">Ссылка</a>
            </div>
        `;
    });
}

// ----------------------
// АРХИВ
// ----------------------
async function loadArchive() {
    const res = await fetch(`${API_BASE}/api/jobs/archive?limit=50`);
    if (res.status !== 200) return;

    const data = await res.json();
    const list = document.getElementById("archive-list");
    list.innerHTML = "";

    data.forEach(job => {
        list.innerHTML += `
            <div class="job">
                <div>${job.text}</div>
                <a href="${job.url}" target="_blank">Ссылка</a>
            </div>
        `;
    });
}

// ----------------------
// TELEGRAM КАНАЛЫ
// ----------------------
async function loadChannels() {
    const res = await fetch(`${API_BASE}/api/channels`);
    const channels = await res.json();

    const list = document.getElementById("channels-list");
    list.innerHTML = "";

    channels.forEach(ch => {
        list.innerHTML += `
            <div class="group-row">
                <input class="group-url-input" value="${ch.url}" readonly>
                <button class="group-enable-btn" onclick="toggleChannel(${ch.id})">
                    ${ch.enabled ? "Отключить" : "Включить"}
                </button>
            </div>
        `;
    });
}

async function toggleChannel(id) {
    await fetch(`${API_BASE}/api/channels/${id}/toggle`, {method: "POST"});
    loadChannels();
}

async function addChannel() {
    const url = document.getElementById("new-channel").value.trim();
    if (!url) return;

    await fetch(`${API_BASE}/api/channels`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({url})
    });

    document.getElementById("new-channel").value = "";
    loadChannels();
}

// ----------------------
// FACEBOOK ГРУППЫ
// ----------------------
async function loadFbGroups() {
    const res = await fetch(`${API_BASE}/api/fb_groups`);
    const groups = await res.json();

    const list = document.getElementById("fb-groups-list");
    list.innerHTML = "";

    groups.forEach(g => {
        list.innerHTML += `
            <div class="group-row">
                <input class="group-url-input" value="${g.group_id}" readonly>
                <button class="group-enable-btn" onclick="toggleFbGroup(${g.id})">
                    ${g.enabled ? "Отключить" : "Включить"}
                </button>
            </div>
        `;
    });
}

async function toggleFbGroup(id) {
    await fetch(`${API_BASE}/api/fb_groups/${id}/toggle`, {method: "POST"});
    loadFbGroups();
}

async function addFbGroup() {
    const url = document.getElementById("new-fb-group").value.trim();
    if (!url) return;

    await fetch(`${API_BASE}/api/fb_groups`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({url})
    });

    document.getElementById("new-fb-group").value = "";
    loadFbGroups();
}

// ----------------------
// АДМИНЫ
// ----------------------
async function loadAdmins() {
    const res = await fetch(`${API_BASE}/api/admins`);
    const admins = await res.json();

    const list = document.getElementById("admin-list");
    list.innerHTML = "";

    admins.forEach(a => {
        list.innerHTML += `
            <div class="group-row">
                <div>${a.user_id}</div>
                <button onclick="removeAdmin(${a.id})">Удалить</button>
            </div>
        `;
    });
}

async function addAdmin() {
    const id = document.getElementById("new-admin").value.trim();
    if (!id) return;

    await fetch(`${API_BASE}/api/admins`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({user_id: id})
    });

    document.getElementById("new-admin").value = "";
    loadAdmins();
}

async function removeAdmin(id) {
    await fetch(`${API_BASE}/api/admins/${id}`, {method: "DELETE"});
    loadAdmins();
}

// ----------------------
initApp();
</script>

</body>
</html>
