<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 12px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 16px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 4px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            font-size: 13px;
            margin-bottom: 12px;
            opacity: 0.8;
        }

        .job-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .job-card.archived {
            opacity: 0.9;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .job-channel,
        .job-text,
        .job-link {
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }

        .job-channel {
            font-weight: 600;
            font-size: 14px;
        }

        .job-date {
            font-size: 12px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .job-text {
            font-size: 14px;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }

        .job-link {
            font-size: 13px;
        }

        .job-link a {
            color: var(--tg-theme-link-color, #2481cc);
            text-decoration: none;
        }

        .job-actions {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn,
        .secondary-btn,
        .delete-btn {
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 12px;
        }

        .btn {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .secondary-btn {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .delete-btn {
            background: #ff4b4b;
            color: #ffffff;
        }

        .loading {
            text-align: center;
            padding: 24px 0;
            font-size: 14px;
            opacity: 0.7;
        }

        .empty-state {
            text-align: center;
            padding: 24px 0;
            font-size: 14px;
            opacity: 0.7;
        }

        .empty-state-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .add-channel-form {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .channels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .channels-count {
            font-size: 13px;
            opacity: 0.8;
        }

        .channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        .channel-info {
            flex: 1;
            min-width: 0;
        }

        .channel-username {
            font-size: 14px;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }

        .channel-date {
            font-size: 12px;
            opacity: 0.7;
        }

        .channel-item .delete-btn {
            flex-shrink: 0;
        }

        @media (max-width: 480px) {
            .channel-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .channel-item .delete-btn {
                align-self: stretch;
                text-align: center;
            }

            .job-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .job-date {
                margin-top: 4px;
            }
        }

        #error-message,
        #success-message {
            margin-bottom: 8px;
        }

        .error,
        .success {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .error {
            background: rgba(255, 75, 75, 0.12);
            color: #d90429;
        }

        .success {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }

        .access-denied {
            padding: 24px 0;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container" id="app-container">
    <h1>–ü–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h1>
    <div class="subtitle">–°–±–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–π –∏–∑ Telegram-–∫–∞–Ω–∞–ª–æ–≤</div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('jobs')">–í–∞–∫–∞–Ω—Å–∏–∏</button>
        <button class="tab" onclick="switchTab('channels')">TG-–∫–∞–Ω–∞–ª—ã</button>
        <button class="tab" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
    </div>

    <div id="error-message"></div>
    <div id="success-message"></div>

    <div id="jobs-tab" class="tab-content active">
        <div id="stats" class="stats">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
        <div id="jobs-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π...</div>
        </div>
    </div>

    <div id="channels-tab" class="tab-content">
        <div class="add-channel-form">
            <div class="input-group">
                <label for="channel-username">Username –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª</label>
                <input
                    type="text"
                    id="channel-username"
                    placeholder="@python_jobs, python_jobs –∏–ª–∏ https://t.me/python_jobs"
                >
            </div>
            <button class="btn" onclick="addChannel()">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</button>
        </div>

        <div class="channels-header">
            <div class="channels-count" id="channels-count"></div>
        </div>

        <div id="channels-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–∞–ª–æ–≤...</div>
        </div>
    </div>

    <div id="archive-tab" class="tab-content">
        <div id="archive-list">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞...</div>
        </div>
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const API_BASE = window.location.origin;
    let currentTab = 'jobs';
    let currentUserId = null;
    let currentUsername = null;
    let accessGranted = false;

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ ---

    async function initApp() {
        try {
            const unsafe = tg.initDataUnsafe || {};
            if (unsafe.user) {
                if (unsafe.user.id) {
                    currentUserId = unsafe.user.id;
                }
                if (unsafe.user.username) {
                    currentUsername = unsafe.user.username;
                }
            }

            const resp = await fetch(`${API_BASE}/api/check_access`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: currentUserId,
                    username: currentUsername
                })
            });

            const data = await resp.json();

            if (!data.allowed) {
                const container = document.getElementById('app-container');
                container.innerHTML = `
                    <div class="access-denied">
                        <h2>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</h2>
                        <p>–≠—Ç–æ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö @username.</p>
                    </div>
                `;
                return;
            }

            accessGranted = true;
            loadJobs();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:', e);
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –ø–æ –¥–µ—Ñ–æ–ª—Ç—É –¥–∞—ë–º –¥–æ—Å—Ç—É–ø, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å UX
            accessGranted = true;
            loadJobs();
        }
    }

    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ---

    function switchTab(tab) {
        if (!accessGranted) return;
        currentTab = tab;

        document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

        document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
        document.getElementById(`${tab}-tab`).classList.add('active');

        if (tab === 'jobs') {
            loadJobs();
        } else if (tab === 'channels') {
            loadChannels();
        } else if (tab === 'archive') {
            loadArchive();
        }
    }

    // --- Jobs ---

    async function loadJobs() {
        if (!accessGranted) return;
        try {
            const response = await fetch(`${API_BASE}/api/jobs?limit=50`);
            const data = await response.json();

            const jobsList = document.getElementById('jobs-list');
            const statsDiv = document.getElementById('stats');

            if (data.stats) {
                const total = data.stats.total || 0;
                const last24 = data.stats.last_24h || 0;
                statsDiv.textContent = `–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π: ${total}. –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞: ${last24}.`;
            } else {
                statsDiv.textContent = '';
            }

            if (data.jobs && data.jobs.length > 0) {
                jobsList.innerHTML = data.jobs.map(job => `
                    <div class="job-card">
                        <div class="job-header">
                            <div class="job-channel">${escapeHtml(job.chat_title || '')}</div>
                            <div class="job-date">${formatDate(job.created_at)}</div>
                        </div>
                        <div class="job-text">${escapeHtml(job.text || '')}</div>
                        ${job.link ? `<div class="job-link"><a href="${job.link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram ‚Üí</a></div>` : ''}
                        <div class="job-actions">
                            ${job.sender_username ? `
                                <button class="secondary-btn" data-username="${escapeAttribute(job.sender_username)}" onclick="handleAuthorClick(event)">
                                    –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É
                                </button>
                            ` : ''}
                            <button class="secondary-btn" onclick="archiveJob(${job.id})">–í –∞—Ä—Ö–∏–≤</button>
                            <button class="delete-btn" onclick="deleteJob(${job.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            } else {
                jobsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîé</div>
                        <div>–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–π</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞–∫–∞–Ω—Å–∏–π');
        }
    }

    // --- Archive ---

    async function loadArchive() {
        if (!accessGranted) return;
        try {
            const response = await fetch(`${API_BASE}/api/jobs/archive?limit=50`);
            const data = await response.json();

            const archiveList = document.getElementById('archive-list');

            if (data.jobs && data.jobs.length > 0) {
                archiveList.innerHTML = data.jobs.map(job => `
                    <div class="job-card archived">
                        <div class="job-header">
                            <div class="job-channel">${escapeHtml(job.chat_title || '')}</div>
                            <div class="job-date">${formatDate(job.created_at)}</div>
                        </div>
                        <div class="job-text">${escapeHtml(job.text || '')}</div>
                        ${job.link ? `<div class="job-link"><a href="${job.link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram ‚Üí</a></div>` : ''}
                        <div class="job-actions">
                            ${job.sender_username ? `
                                <button class="secondary-btn" data-username="${escapeAttribute(job.sender_username)}" onclick="handleAuthorClick(event)">
                                    –ù–∞–ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É
                                </button>
                            ` : ''}
                            <button class="secondary-btn" onclick="restoreJob(${job.id})">–í–µ—Ä–Ω—É—Ç—å</button>
                            <button class="delete-btn" onclick="deleteJob(${job.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');
            } else {
                archiveList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞');
        }
    }

    // --- Channels ---

    async function loadChannels() {
        if (!accessGranted) return;
        try {
            const response = await fetch(`${API_BASE}/api/channels`);
            const data = await response.json();

            const channelsList = document.getElementById('channels-list');
            const channelsCount = document.getElementById('channels-count');

            if (data.channels && data.channels.length > 0) {
                channelsCount.textContent = `–í—Å–µ–≥–æ TG-–∫–∞–Ω–∞–ª–æ–≤: ${data.channels.length}`;
                channelsList.innerHTML = data.channels.map(channel => `
                    <div class="channel-item">
                        <div class="channel-info">
                            <div class="channel-username">${escapeHtml(channel.username)}</div>
                            <div class="channel-date">–î–æ–±–∞–≤–ª–µ–Ω: ${formatDate(channel.added_at)}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteChannel(${channel.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `).join('');
            } else {
                channelsCount.textContent = '–ö–∞–Ω–∞–ª—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã';
                channelsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¢</div>
                        <div>–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–∞–ª–æ–≤');
        }
    }

    async function addChannel() {
        if (!accessGranted) return;
        const input = document.getElementById('channel-username');
        const rawInput = input.value.trim();

        if (!rawInput) {
            showError('–í–≤–µ–¥–∏—Ç–µ username –∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª');
            return;
        }

        const username = extractUsername(rawInput);

        if (!username) {
            showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: @username, username –∏–ª–∏ https://t.me/username');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/api/channels`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username })
            });

            const data = await response.json();

            if (!response.ok) {
                showError(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
                return;
            }

            showSuccess(`–ö–∞–Ω–∞–ª ${username} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω`);
            input.value = '';
            loadChannels();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
            showError('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
        }
    }

    async function deleteChannel(channelId) {
        if (!accessGranted) return;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª? –ü–∞—Ä—Å–µ—Ä –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –µ–≥–æ —á–∏—Ç–∞—Ç—å.')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/api/channels/${channelId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!response.ok) {
                showError(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
                return;
            }

            showSuccess('–ö–∞–Ω–∞–ª —É–¥–∞–ª—ë–Ω');
            loadChannels();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
            showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
        }
    }

    // --- Job actions ---

    async function archiveJob(jobId) {
        if (!accessGranted) return;
        try {
            const response = await fetch(`${API_BASE}/api/jobs/${jobId}/archive`, {
                method: 'POST'
            });

            const data = await response.json();
            if (!response.ok) {
                showError(data.error || '–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –≤–∞–∫–∞–Ω—Å–∏–∏');
                return;
            }

            showSuccess('–í–∞–∫–∞–Ω—Å–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤');
            loadJobs();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –≤–∞–∫–∞–Ω—Å–∏–∏:', error);
            showError('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –≤–∞–∫–∞–Ω—Å–∏–∏');
        }
    }

    async function restoreJob(jobId) {
        if (!accessGranted) return;
        try {
            const response = await fetch(`${API_BASE}/api/jobs/${jobId}/restore`, {
                method: 'POST'
            });

            const data = await response.json();
            if (!response.ok) {
                showError(data.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏');
                return;
            }

            showSuccess('–í–∞–∫–∞–Ω—Å–∏—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –∏–∑ –∞—Ä—Ö–∏–≤–∞');
            loadArchive();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏:', error);
            showError('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏');
        }
    }

    async function deleteJob(jobId) {
        if (!accessGranted) return;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/api/jobs/${jobId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (!response.ok) {
                showError(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏');
                return;
            }

            showSuccess('–í–∞–∫–∞–Ω—Å–∏—è —É–¥–∞–ª–µ–Ω–∞');
            if (currentTab === 'jobs') {
                loadJobs();
            } else if (currentTab === 'archive') {
                loadArchive();
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏:', error);
            showError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏');
        }
    }

    function handleAuthorClick(event) {
        const btn = event.currentTarget;
        const username = btn.getAttribute('data-username') || '';
        writeToAuthor(username);
    }

    function writeToAuthor(username) {
        if (!username) return;
        let clean = username.trim();
        if (clean.startsWith('@')) {
            clean = clean.slice(1);
        }
        if (!clean) return;
        const url = `https://t.me/${encodeURIComponent(clean)}`;
        window.open(url, '_blank');
    }

    // --- Utils ---

    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeAttribute(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (Number.isNaN(date.getTime())) return '';

        const now = new Date();
        const diff = now - date;

        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
        if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
        if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`;
        if (days < 7) return `${days} –¥–Ω –Ω–∞–∑–∞–¥`;

        return date.toLocaleDateString('ru-RU');
    }

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        setTimeout(() => {
            errorDiv.innerHTML = '';
        }, 3500);
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        successDiv.innerHTML = `<div class="success">${escapeHtml(message)}</div>`;
        setTimeout(() => {
            successDiv.innerHTML = '';
        }, 3000);
    }

    function extractUsername(input) {
        let value = input.trim();

        if (value.startsWith('https://t.me/')) {
            value = value.replace('https://t.me/', '');
        } else if (value.startsWith('http://t.me/')) {
            value = value.replace('http://t.me/', '');
        }

        if (value.startsWith('@')) {
            value = value.slice(1);
        }

        value = value.replace(/\/+$/, '');

        if (!value) return null;

        return `@${value}`;
    }

    // –°—Ç–∞—Ä—Ç
    initApp();
</script>
</body>
</html>
