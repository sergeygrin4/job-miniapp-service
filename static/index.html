<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job MiniApp</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --text-muted: #666666;
      --card: #f6f7f9;
      --border: #e0e0e0;
      --btn: #2a7fff;
      --btn2: #1f6de0;
      --danger: #ff3b30;
      --ok: #21c45a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px;
    }

    .topbar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .title {
      font-weight: 600;
      font-size: 18px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .tab {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }

    .tab.active {
      background: var(--card);
      font-weight: 600;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin: 10px 0;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1;
      min-width: 260px;
    }

    .btn {
      border: none;
      background: var(--btn);
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover {
      background: var(--btn2);
    }

    .btn-outline {
      background: #fff;
      color: var(--btn);
      border: 1px solid var(--btn);
    }

    .btn-outline:hover {
      background: #eef5ff;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-secondary {
      background: #3a3a3a;
    }

    .btn-secondary:hover {
      background: #2b2b2b;
    }

    input, textarea, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }

    .job {
      white-space: pre-wrap;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .job-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border);
    }

    .badge-ok {
      border-color: var(--ok);
      color: var(--ok);
    }

    .badge-danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .badge-muted {
      border-style: dashed;
    }

    .job-actions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }

    .pill input[type="checkbox"] {
      margin: 0;
    }

    .flash {
      margin-bottom: 8px;
      font-size: 13px;
    }

    .flash-ok {
      color: var(--ok);
    }

    .flash-error {
      color: var(--danger);
    }

    .hidden {
      display: none !important;
    }

    .small-input-inline {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .small-input-inline input {
      flex: 1;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.04);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item-main {
      font-size: 14px;
    }

    .list-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .text-right {
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Job MiniApp</div>
      <div id="user-info" class="muted"></div>
    </div>

    <div id="flash" class="flash hidden"></div>

    <div id="access-denied" class="card hidden">
      <b>Доступ запрещён</b>
      <p class="muted" style="margin-top:4px;">
        Тебя нет в списке доступа. Напиши админу, чтобы он добавил твой @username
        на вкладке <b>⚙️ Настройки → Доступ</b>.
      </p>
    </div>

    <div id="main" class="hidden">
      <div class="tabs">
        <div class="tab active" data-tab="jobs">Вакансии</div>
        <div class="tab" data-tab="groups">Группы</div>
        <div class="tab admin-only" data-tab="settings">⚙️ Настройки</div>
        <div class="tab admin-only" data-tab="access">Доступ</div>
      </div>

      <!-- TAB: JOBS -->
      <div id="tab-jobs" class="tab-page">
        <div class="card">
          <div class="row">
            <div class="col">
              <label>Поиск по тексту</label>
              <input id="jobs-q" placeholder="ключевые слова..." />
            </div>
            <div class="col">
              <label>Источник (source)</label>
              <input id="jobs-source" placeholder="facebook / t.me/... (необязательно)" />
            </div>
            <div class="col">
              <label>&nbsp;</label>
              <div class="small-input-inline">
                <label class="pill">
                  <input type="checkbox" id="jobs-archived" />
                  <span>Показать архив</span>
                </label>
                <button class="btn btn-secondary" id="jobs-refresh-btn">Обновить</button>
              </div>
            </div>
          </div>
          <p class="muted" style="margin-top:6px;">
            Здесь видно то, что прилетело от FB и TG парсеров через endpoint <code>/post</code>.
          </p>
        </div>

        <div id="jobs-list"></div>
      </div>

      <!-- TAB: GROUPS -->
      <div id="tab-groups" class="tab-page hidden">
        <div class="card">
          <div class="row">
            <div class="col">
              <label>Новый источник (ID / URL)</label>
              <input id="group-id-input" placeholder="https://t.me/..., slug или id группы FB" />
            </div>
            <div class="col">
              <label>Название (опционально)</label>
              <input id="group-name-input" placeholder="Как будем отображать" />
            </div>
            <div class="col">
              <label>&nbsp;</label>
              <button class="btn" id="group-add-btn">Добавить</button>
            </div>
          </div>
          <p class="muted" style="margin-top:6px;">
            Список отсюда использует Telegram-парсер (<code>/api/groups</code>) и FB-парсер
            (<code>/api/fb_groups</code>).
          </p>
        </div>

        <div id="groups-list"></div>
      </div>

      <!-- TAB: SETTINGS -->
      <div id="tab-settings" class="tab-page hidden">
        <!-- Общий статус -->
        <div class="card">
          <b>Состояние аккаунтов</b>
          <div id="secrets-status" class="muted" style="margin-top:6px;">
            Загрузка статуса...
          </div>
        </div>

        <!-- FB cookies -->
        <div class="card">
          <b>Facebook cookies (Apify)</b>
          <p class="muted" style="margin-top:4px;">
            Вставь JSON из Apify (масси... объектов cookies). Формат:
            <code>[{"key": "...", "value": "...", ...}, ...]</code>.
          </p>
          <textarea id="fb-cookies-text" placeholder='[{"key":"c_user","value":"..."}, ...]'></textarea>
          <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
            <button class="btn" id="fb-cookies-save-btn">Сохранить cookies</button>
          </div>
        </div>

        <!-- TG session manual -->
        <div class="card">
          <b>Telegram: StringSession (ручной ввод)</b>
          <p class="muted" style="margin-top:4px;">
            Если у тебя уже есть StringSession (например, из локального скрипта),
            можно просто вставить её сюда.
          </p>
          <textarea id="tg-session-text" placeholder="1AAABbCc..."></textarea>
          <div style="margin-top:8px;">
            <button class="btn btn-secondary" id="tg-session-save-btn">Сохранить StringSession</button>
          </div>
        </div>

        <!-- TG semi-auto login -->
        <div class="card">
          <b>Telegram: полуавтоматический логин по коду</b>
          <p class="muted" style="margin-top:4px;">
            Шаг 1 — вводишь номер, мы отправляем код через MiniApp-бэкенд.<br/>
            Шаг 2 — вводишь код (и пароль 2FA, если есть), бэкенд сохраняет новую StringSession
            в хранилище, и её автоматически подхватит парсер.
          </p>

          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label>Телефон (+7999...)</label>
              <input id="tg-phone-input" placeholder="+79991234567" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn" id="tg-send-code-btn">Отправить код</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <label>Код из Telegram</label>
              <input id="tg-code-input" placeholder="12345" />
            </div>
            <div class="col">
              <label>Пароль 2FA (если включён)</label>
              <input id="tg-password-input" type="password" placeholder="опционально" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn btn-outline" id="tg-confirm-code-btn">Подтвердить код, создать сессию</button>
            </div>
          </div>

          <p id="tg-auth-hint" class="muted" style="margin-top:6px;"></p>
        </div>
      </div>

      <!-- TAB: ACCESS -->
      <div id="tab-access" class="tab-page hidden">
        <div class="card">
          <b>Разрешённые пользователи</b>
          <p class="muted" style="margin-top:4px;">
            Любой, кто открывает миниапп, сначала бьётся в <code>/check_access</code>.
            Здесь можно управлять списком тех, кому есть доступ.
          </p>

          <div id="allowed-users-list" style="margin-top:8px;"></div>
        </div>

        <div class="card">
          <b>Добавить пользователя</b>
          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label>username без @</label>
              <input id="allowed-username-input" placeholder="username" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn" id="allowed-add-btn">Добавить</button>
            </div>
          </div>
          <p class="muted" style="margin-top:6px;">
            user_id подтянется автоматически при первом заходе пользователя в миниапп.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const state = {
      initData: "",
      user: null,
      isAdmin: false,
    };

    const qs = new URLSearchParams(location.search);

    function $(id) {
      return document.getElementById(id);
    }

    function showFlash(message, isError = false) {
      const el = $("flash");
      if (!message) {
        el.classList.add("hidden");
        el.textContent = "";
        return;
      }
      el.textContent = message;
      el.classList.remove("hidden");
      el.classList.toggle("flash-error", !!isError);
      el.classList.toggle("flash-ok", !isError);
    }

    function formatDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("ru-RU", { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" });
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function adminHeaders() {
      const h = { "Content-Type": "application/json" };
      if (state.initData) {
        h["X-TG-INIT-DATA"] = state.initData;
      }
      return h;
    }

    async function apiFetch(url, { method = "GET", body = null, admin = false } = {}) {
      const init = {
        method,
        headers: admin ? adminHeaders() : { "Content-Type": "application/json" },
      };
      if (body != null) {
        init.body = JSON.stringify(body);
      }
      const res = await fetch(url, init);
      let data = null;
      try {
        data = await res.json();
      } catch (e) {
        // ignore
      }
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return data;
    }

    function updateUserInfoUI() {
      const el = $("user-info");
      if (!state.user) {
        el.textContent = "";
        return;
      }
      const username = state.user.username ? "@" + state.user.username : ("id=" + state.user.id);
      el.textContent = username + (state.isAdmin ? " · админ" : "");
    }

    async function checkAccess() {
      if (!state.user) {
        $("access-denied").classList.remove("hidden");
        return;
      }
      try {
        const resp = await apiFetch("/check_access", {
          method: "POST",
          body: {
            user_id: state.user.id,
            username: state.user.username || "",
          },
        });

        if (!resp.access_granted) {
          $("access-denied").classList.remove("hidden");
          $("main").classList.add("hidden");
          showFlash("Нет доступа к миниаппу", true);
          return;
        }

        state.isAdmin = !!resp.is_admin;
        updateUserInfoUI();

        // скрываем/показываем админ-вкладки
        document.querySelectorAll(".admin-only").forEach((el) => {
          if (state.isAdmin) el.classList.remove("hidden");
          else el.classList.add("hidden");
        });

        $("access-denied").classList.add("hidden");
        $("main").classList.remove("hidden");

        // начальная загрузка данных
        loadJobs();
        loadGroups();
        if (state.isAdmin) {
          loadSecretsStatus();
          loadAllowedUsers();
        }
      } catch (e) {
        console.error(e);
        showFlash("Ошибка /check_access: " + e.message, true);
        $("access-denied").classList.remove("hidden");
      }
    }

    // ----- JOBS -----

    async function loadJobs() {
      const q = $("jobs-q").value.trim();
      const source = $("jobs-source").value.trim();
      const archived = $("jobs-archived").checked;

      const params = new URLSearchParams();
      params.set("limit", "50");
      params.set("archived", archived ? "true" : "false");
      if (q) params.set("q", q);
      if (source) params.set("source", source);

      try {
        const data = await apiFetch("/api/jobs?" + params.toString());
        const list = $("jobs-list");
        const jobs = data.jobs || [];
        if (!jobs.length) {
          list.innerHTML = '<div class="card muted">Пока ничего нет.</div>';
          return;
        }

        list.innerHTML = jobs
          .map((j) => {
            const src = escapeHtml(j.source || "");
            const srcName = escapeHtml(j.source_name || "");
            const url = escapeHtml(j.url || "");
            const sender = escapeHtml(j.sender_username || "");
            const created = formatDate(j.created_at);
            const received = formatDate(j.received_at);
            const archivedBadge = j.archived
              ? '<span class="badge badge-danger">В архиве</span>'
              : "";
            const linkHtml = url
              ? `<a href="${url}" target="_blank" rel="noopener noreferrer">Открыть пост</a>`
              : "";

            const archiveBtn = state.isAdmin
              ? `<button class="btn btn-outline btn-xs" data-job-id="${j.id}" data-archived="${j.archived ? "true" : "false"}">
                   ${j.archived ? "Вернуть из архива" : "В архив"}
                 </button>`
              : "";

            return `
              <div class="card">
                <div class="job">${escapeHtml(j.text || "")}</div>
                <div class="job-meta">
                  <span class="badge">${srcName || src || "unknown"}</span>
                  ${archivedBadge}
                  <span>Создано: ${created}</span>
                  <span>Получено: ${received}</span>
                  ${sender ? `<span>Автор: ${sender}</span>` : ""}
                  ${linkHtml ? `<span>${linkHtml}</span>` : ""}
                </div>
                ${archiveBtn ? `<div class="job-actions">${archiveBtn}</div>` : ""}
              </div>`;
          })
          .join("");

        if (state.isAdmin) {
          $("jobs-list").querySelectorAll("button[data-job-id]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-job-id");
              const isArchived = btn.getAttribute("data-archived") === "true";
              try {
                await apiFetch(`/api/jobs/${id}/archive`, {
                  method: "POST",
                  admin: true,
                  body: { archived: !isArchived },
                });
                showFlash("Статус вакансии обновлён");
                loadJobs();
              } catch (e) {
                console.error(e);
                showFlash("Ошибка архивирования: " + e.message, true);
              }
            });
          });
        }
      } catch (e) {
        console.error(e);
        showFlash("Ошибка загрузки вакансий: " + e.message, true);
      }
    }

    // ----- GROUPS -----

    async function loadGroups() {
      try {
        const data = await apiFetch("/api/groups");
        const groups = data.groups || [];
        const list = $("groups-list");
        if (!groups.length) {
          list.innerHTML = '<div class="card muted">Пока ни одной группы не добавлено.</div>';
          return;
        }

        list.innerHTML = groups
          .map((g) => {
            const id = g.id;
            const gid = g.group_id || "";
            const name = g.group_name || "";
            const enabled = !!g.enabled;
            const added = formatDate(g.added_at);
            return `
              <div class="card">
                <div class="list-item">
                  <div class="list-item-main">
                    <div><b>${escapeHtml(name || gid)}</b></div>
                    <div class="list-item-meta">
                      <span>group_id: ${escapeHtml(gid)}</span>
                      <span>Добавлено: ${added}</span>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="pill">
                      <input type="checkbox" data-action="toggle" data-id="${id}" ${enabled ? "checked" : ""}/>
                      <span>${enabled ? "Включено" : "Выключено"}</span>
                    </div>
                    ${state.isAdmin ? `<button class="btn btn-outline btn-danger" style="margin-top:6px;" data-action="delete" data-id="${id}">Удалить</button>` : ""}
                  </div>
                </div>
              </div>`;
          })
          .join("");

        if (state.isAdmin) {
          list.querySelectorAll("input[data-action='toggle']").forEach((ch) => {
            ch.addEventListener("change", async () => {
              const id = ch.getAttribute("data-id");
              const enabled = ch.checked;
              try {
                await apiFetch(`/api/groups/${id}/toggle`, {
                  method: "POST",
                  admin: true,
                  body: { enabled },
                });
                showFlash("Статус группы обновлён");
                loadGroups();
              } catch (e) {
                console.error(e);
                showFlash("Ошибка обновления группы: " + e.message, true);
              }
            });
          });

          list.querySelectorAll("button[data-action='delete']").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-id");
              if (!confirm("Удалить группу?")) return;
              try {
                await apiFetch(`/api/groups/${id}`, {
                  method: "DELETE",
                  admin: true,
                });
                showFlash("Группа удалена");
                loadGroups();
              } catch (e) {
                console.error(e);
                showFlash("Ошибка удаления группы: " + e.message, true);
              }
            });
          });
        }
      } catch (e) {
        console.error(e);
        showFlash("Ошибка загрузки групп: " + e.message, true);
      }
    }

    // ----- SECRETS / SETTINGS -----

    async function loadSecretsStatus() {
      try {
        const data = await apiFetch("/api/admin/secrets", { admin: true });
        const fbAt = data.fb_cookies_updated_at;
        const tgAt = data.tg_session_updated_at;
        const pending = data.tg_auth_pending || null;

        const lines = [];
        lines.push("Facebook cookies: " + formatDate(fbAt));
        lines.push("Telegram StringSession: " + formatDate(tgAt));
        if (pending && pending.phone) {
          lines.push(
            "Ожидается подтверждение кода для " +
              pending.phone +
              " (запущено: " +
              formatDate(pending.started_at) +
              ")"
          );
        } else {
          lines.push("Нет активного процесса авторизации по коду.");
        }

        $("secrets-status").innerHTML = lines.map(escapeHtml).join("<br/>");
      } catch (e) {
        console.error(e);
        $("secrets-status").textContent = "Ошибка загрузки статуса: " + e.message;
      }
    }

    async function saveFbCookies() {
      const raw = $("fb-cookies-text").value.trim();
      if (!raw) {
        showFlash("Вставь JSON с cookies", true);
        return;
      }
      try {
        // валидация на фронте для удобства
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) {
          showFlash("cookies_json должен быть массивом", true);
          return;
        }
      } catch (e) {
        showFlash("Некорректный JSON cookies: " + e.message, true);
        return;
      }

      try {
        await apiFetch("/api/admin/fb_cookies", {
          method: "POST",
          admin: true,
          body: { cookies_json: raw },
        });
        showFlash("Facebook cookies сохранены");
        loadSecretsStatus();
      } catch (e) {
        console.error(e);
        showFlash("Ошибка сохранения cookies: " + e.message, true);
      }
    }

    async function saveTgSessionManual() {
      const session = $("tg-session-text").value.trim();
      if (!session) {
        showFlash("Вставь StringSession", true);
        return;
      }
      try {
        await apiFetch("/api/admin/tg_session", {
          method: "POST",
          admin: true,
          body: { session },
        });
        showFlash("Telegram StringSession сохранена");
        loadSecretsStatus();
      } catch (e) {
        console.error(e);
        showFlash("Ошибка сохранения StringSession: " + e.message, true);
      }
    }

    async function tgAuthStart() {
      const phone = $("tg-phone-input").value.trim();
      if (!phone) {
        showFlash("Введи телефон", true);
        return;
      }
      try {
        await apiFetch("/api/admin/tg_auth/start", {
          method: "POST",
          admin: true,
          body: { phone },
        });
        showFlash("Код отправлен в Telegram. Введи его ниже.");
        $("tg-auth-hint").textContent = "Код отправлен. Введи код и пароль 2FA (если есть), затем нажми «Подтвердить код».";

        loadSecretsStatus();
      } catch (e) {
        console.error(e);
        showFlash("Ошибка отправки кода: " + e.message, true);
      }
    }

    async function tgAuthConfirm() {
      const code = $("tg-code-input").value.trim();
      const password = $("tg-password-input").value.trim() || null;
      if (!code) {
        showFlash("Введи код из Telegram", true);
        return;
      }
      try {
        await apiFetch("/api/admin/tg_auth/confirm", {
          method: "POST",
          admin: true,
          body: { code, password },
        });
        showFlash("Telegram StringSession успешно создана и сохранена");
        $("tg-auth-hint").textContent = "";
        $("tg-code-input").value = "";
        $("tg-password-input").value = "";
        loadSecretsStatus();
      } catch (e) {
        console.error(e);
        showFlash("Ошибка подтверждения кода: " + e.message, true);
      }
    }

    // ----- ALLOWED USERS -----

    async function loadAllowedUsers() {
      try {
        const data = await apiFetch("/api/allowed_users", { admin: true });
        const users = data.users || [];
        const list = $("allowed-users-list");
        if (!users.length) {
          list.innerHTML = '<div class="muted">Список пуст.</div>';
          return;
        }
        list.innerHTML = users
          .map((u) => {
            const updated = formatDate(u.updated_at);
            return `
              <div class="list-item">
                <div>
                  <div class="list-item-main"><b>@${escapeHtml(u.username)}</b></div>
                  <div class="list-item-meta">
                    <span>ID: ${escapeHtml(u.user_id ?? "")}</span>
                    <span>Обновлено: ${updated}</span>
                  </div>
                </div>
                <div>
                  <button class="btn btn-outline btn-danger" data-id="${u.id}">Удалить</button>
                </div>
              </div>`;
          })
          .join("");

        list.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!confirm("Удалить пользователя из списка доступа?")) return;
            try {
              await apiFetch(`/api/allowed_users/${id}`, {
                method: "DELETE",
                admin: true,
              });
              showFlash("Пользователь удалён из доступа");
              loadAllowedUsers();
            } catch (e) {
              console.error(e);
              showFlash("Ошибка удаления пользователя: " + e.message, true);
            }
          });
        });
      } catch (e) {
        console.error(e);
        showFlash("Ошибка загрузки списка доступа: " + e.message, true);
      }
    }

    async function addAllowedUser() {
      const username = $("allowed-username-input").value.trim().replace(/^@/, "");
      if (!username) {
        showFlash("Введи username без @", true);
        return;
      }
      try {
        await apiFetch("/api/allowed_users", {
          method: "POST",
          admin: true,
          body: { username },
        });
        $("allowed-username-input").value = "";
        showFlash("Пользователь добавлен/обновлён");
        loadAllowedUsers();
      } catch (e) {
        console.error(e);
        showFlash("Ошибка добавления пользователя: " + e.message, true);
      }
    }

    // ----- TABS -----

    function initTabs() {
      const tabs = document.querySelectorAll(".tab");
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          const name = tab.getAttribute("data-tab");
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          document.querySelectorAll(".tab-page").forEach((page) => {
            page.classList.add("hidden");
          });
          const page = document.getElementById("tab-" + name);
          if (page) page.classList.remove("hidden");
        });
      });
    }

    function initEvents() {
      $("jobs-refresh-btn").addEventListener("click", () => loadJobs());
      $("jobs-q").addEventListener("keydown", (e) => {
        if (e.key === "Enter") loadJobs();
      });

      $("group-add-btn").addEventListener("click", async () => {
        const gid = $("group-id-input").value.trim();
        const name = $("group-name-input").value.trim();
        if (!gid) {
          showFlash("Укажи group_id / URL", true);
          return;
        }
        try {
          await apiFetch("/api/groups", {
            method: "POST",
            admin: true,
            body: { group_id: gid, group_name: name },
          });
          $("group-id-input").value = "";
          $("group-name-input").value = "";
          showFlash("Группа добавлена/обновлена");
          loadGroups();
        } catch (e) {
          console.error(e);
          showFlash("Ошибка добавления группы: " + e.message, true);
        }
      });

      $("fb-cookies-save-btn").addEventListener("click", saveFbCookies);
      $("tg-session-save-btn").addEventListener("click", saveTgSessionManual);
      $("tg-send-code-btn").addEventListener("click", tgAuthStart);
      $("tg-confirm-code-btn").addEventListener("click", tgAuthConfirm);
      $("allowed-add-btn").addEventListener("click", addAllowedUser);
    }

    function initTelegram() {
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        state.initData = tg.initData || "";
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
          state.user = tg.initDataUnsafe.user;
        }
        try {
          tg.ready();
          tg.expand();
        } catch (e) {
          console.warn("Telegram WebApp init error", e);
        }
      } else {
        // Фоллбек для локальной отладки (без Telegram)
        const fakeUser = qs.get("debug_user");
        if (fakeUser) {
          state.user = { id: 1, username: fakeUser };
        }
      }
      updateUserInfoUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTabs();
      initEvents();
      initTelegram();
      checkAccess();
    });
  </script>
</body>
</html>
