<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Job MiniApp</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --muted: #666666;
      --card: #f6f7f9;
      --border: #e0e0e0;
      --btn: #2a7fff;
      --btn-hover: #1f6de0;
      --danger: #ff3b30;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .title {
      font-weight: 600;
      font-size: 18px;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tab {
      padding: 6px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }

    .tab.active {
      background: var(--card);
      font-weight: 600;
    }

    .card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px;
      margin: 8px 0;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .col {
      flex: 1;
      min-width: 240px;
    }

    input, textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      display: block;
    }

    .muted {
      font-size: 12px;
      color: var(--muted);
    }

    .btn {
      border: none;
      border-radius: 10px;
      background: var(--btn);
      color: #fff;
      font-size: 14px;
      padding: 7px 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn:hover { background: var(--btn-hover); }

    .btn-secondary {
      background: #444;
    }

    .btn-secondary:hover {
      background: #333;
    }

    .btn-outline {
      background: #fff;
      color: var(--btn);
      border: 1px solid var(--btn);
    }

    .btn-outline:hover {
      background: #eef4ff;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .job {
      white-space: pre-wrap;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .job-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--border);
      font-size: 11px;
    }

    .job-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .flash {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .flash-ok { color: #0a9b3f; }
    .flash-error { color: var(--danger); }

    .hidden { display: none !important; }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.05);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-main { font-size: 14px; }
    .list-meta { font-size: 12px; color: var(--muted); }
    .list-meta span { word-break: break-all; }

    .text-right { text-align: right; }

    hr {
      border: none;
      border-top: 1px dashed rgba(0,0,0,0.1);
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Job MiniApp</div>
      <div id="user-info" class="muted"></div>
    </div>

    <div id="flash" class="flash hidden"></div>

    <div id="access-denied" class="card hidden">
      <b>Доступ запрещён</b>
      <p class="muted" style="margin-top:4px;">
        Тебя нет в списке доступа. Напиши админу, чтобы он добавил твой @username
        на вкладке <b>Доступ</b>.
      </p>
    </div>

    <div id="main" class="hidden">
      <div class="tabs">
        <div class="tab active" data-tab="jobs">Вакансии</div>
        <div class="tab" data-tab="groups">Группы</div>
        <div class="tab admin-only" data-tab="settings">⚙️ Настройки</div>
        <div class="tab" data-tab="archive">Архив</div>
        <div class="tab admin-only" data-tab="access">Доступ</div>
      </div>

      <!-- Вакансии -->
      <div id="tab-jobs" class="tab-page">
        <div class="card">
          <button class="btn" id="jobs-refresh-btn">Обновить</button>
          <p class="muted" style="margin-top:6px;">
            Здесь видно то, что прилетело от FB и TG парсеров через endpoint <code>/post</code>.
          </p>
        </div>
        <div id="jobs-list"></div>
      </div>

      <!-- Архив -->
      <div id="tab-archive" class="tab-page hidden">
        <div class="card">
          <button class="btn" id="archive-refresh-btn">Обновить архив</button>
          <p class="muted" style="margin-top:6px;">
            Здесь отображаются вакансии, которые были отправлены в архив.
          </p>
        </div>
        <div id="archive-list"></div>
      </div>

      <!-- Группы -->
      <div id="tab-groups" class="tab-page hidden">
        <div class="card">
          <div class="row">
            <div class="col">
              <label>Новый источник (ID / URL)</label>
              <input id="group-id-input" placeholder="https://t.me/..., slug или id группы FB" />
            </div>
            <div class="col">
              <label>Название (опционально)</label>
              <input id="group-name-input" placeholder="Как будем отображать" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn" id="group-add-btn">Добавить</button>
            </div>
          </div>
          <p class="muted" style="margin-top:6px;">
            Список отсюда использует Telegram-парсер (<code>/api/groups</code>) и FB-парсер (<code>/api/fb_groups</code>).
          </p>
        </div>
        <div id="groups-list"></div>
      </div>

      <!-- Настройки (только админы) -->
      <div id="tab-settings" class="tab-page hidden">
        <div class="card">
          <b>Facebook cookies (Apify)</b>
          <p class="muted" style="margin-top:4px;">
            1) Один раз сохрани <b>полный JSON</b> cookies, который даёт Apify.<br/>
            2) Дальше обычно меняются только значения (например <code>c_user</code>, <code>xs</code>, <code>fr</code>) —
            ниже можно обновлять только их.
          </p>

          <label>Полный JSON cookies (при первичной настройке или если структура поменялась)</label>
          <textarea id="fb-cookies-json" placeholder='[{"key":"c_user","value":"..."}, ...]'></textarea>
          <div style="margin-top:6px;">
            <button class="btn" id="fb-cookies-json-btn">Сохранить полный JSON</button>
          </div>

          <hr/>

          <label>Динамичные cookie</label>
          <p class="muted" style="margin-top:2px;">
            Сюда можно вставлять только текущие значения из браузера — мы подменим их в сохранённом JSON.
          </p>

          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label>c_user</label>
              <input id="fb-cookies-c_user" placeholder="значение c_user" />
            </div>
            <div class="col">
              <label>xs</label>
              <input id="fb-cookies-xs" placeholder="значение xs" />
            </div>
          </div>
          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label>fr</label>
              <input id="fb-cookies-fr" placeholder="значение fr" />
            </div>
            <div class="col">
              <label>datr (опционально)</label>
              <input id="fb-cookies-datr" placeholder="значение datr" />
            </div>
          </div>
          <div style="margin-top:8px;">
            <button class="btn btn-secondary" id="fb-cookies-dynamic-btn">Обновить значения cookies</button>
          </div>
        </div>

        <div class="card">
          <b>Telegram StringSession (ручной ввод)</b>
          <p class="muted" style="margin-top:4px;">
            Если у тебя уже есть готовая StringSession (локальный скрипт и т.п.), просто вставь её сюда.
          </p>
          <textarea id="tg-session-text" placeholder="1AAABbCc..."></textarea>
          <div style="margin-top:6px;">
            <button class="btn" id="tg-session-save-btn">Сохранить StringSession</button>
          </div>
        </div>

        <div class="card">
          <b>Telegram: полуавтоматический логин по коду</b>
          <p class="muted" style="margin-top:4px;">
            Шаг 1 — вводишь номер, мы отправляем код.<br/>
            Шаг 2 — вводишь код (и пароль 2FA, если есть), после чего миниапп сохранит новую StringSession,
            а парсер её подхватит.
          </p>
          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label>Телефон (+7999...)</label>
              <input id="tg-phone-input" placeholder="+79991234567" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn" id="tg-send-code-btn">Отправить код</button>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div class="col">
              <label>Код из Telegram</label>
              <input id="tg-code-input" placeholder="12345" />
            </div>
            <div class="col">
              <label>Пароль 2FA (если включён)</label>
              <input id="tg-password-input" type="password" placeholder="опционально" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn btn-outline" id="tg-confirm-code-btn">Подтвердить код, создать сессию</button>
            </div>
          </div>
          <p id="tg-auth-hint" class="muted" style="margin-top:6px;"></p>
        </div>
      </div>

      <!-- Доступ (только админы) -->
      <div id="tab-access" class="tab-page hidden">
        <div class="card">
          <b>Разрешённые пользователи</b>
          <p class="muted" style="margin-top:4px;">
            Любой, кто открывает миниапп, сначала бьётся в <code>/check_access</code>.
            Здесь можно управлять списком тех, кому есть доступ.
          </p>
          <div id="allowed-users-list" style="margin-top:8px;"></div>
        </div>

        <div class="card">
          <b>Добавить пользователя</b>
          <div class="row" style="margin-top:6px;">
            <div class="col">
              <label>username без @</label>
              <input id="allowed-username-input" placeholder="username" />
            </div>
            <div class="col" style="align-self:flex-end;">
              <button class="btn" id="allowed-add-btn">Добавить</button>
            </div>
          </div>
          <p class="muted" style="margin-top:6px;">
            user_id подтянется автоматически при первом заходе пользователя в миниапп.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const state = {
      user: null,
      initData: "",
      isAdmin: false,
    };

    function $(id) { return document.getElementById(id); }

    function showFlash(msg, isError = false) {
      const el = $("flash");
      if (!msg) {
        el.classList.add("hidden");
        el.textContent = "";
        return;
      }
      el.textContent = msg;
      el.classList.remove("hidden");
      el.classList.toggle("flash-error", !!isError);
      el.classList.toggle("flash-ok", !isError);
    }

    function formatDate(iso) {
      if (!iso) return "—";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      return d.toLocaleString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function adminHeaders() {
      const h = { "Content-Type": "application/json" };
      if (state.initData) h["X-TG-INIT-DATA"] = state.initData;
      if (state.user && state.user.username) h["X-ADMIN-USERNAME"] = state.user.username;
      return h;
    }

    async function apiFetch(url, { method = "GET", body = null, admin = false } = {}) {
      const init = {
        method,
        headers: admin ? adminHeaders() : { "Content-Type": "application/json" },
      };
      if (body != null) init.body = JSON.stringify(body);
      const res = await fetch(url, init);
      let data = null;
      try { data = await res.json(); } catch (e) {}
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return data;
    }

    function updateUserInfoUI() {
      const el = $("user-info");
      if (!state.user) { el.textContent = ""; return; }
      const uname = state.user.username ? "@" + state.user.username : ("id=" + state.user.id);
      el.textContent = uname + (state.isAdmin ? " · админ" : "");
    }

    async function checkAccess() {
      if (!state.user) {
        $("access-denied").classList.remove("hidden");
        return;
      }
      try {
        const resp = await apiFetch("/check_access", {
          method: "POST",
          body: { user_id: state.user.id, username: state.user.username || "" },
        });
        if (!resp.access_granted) {
          $("access-denied").classList.remove("hidden");
          $("main").classList.add("hidden");
          showFlash("Нет доступа к миниаппу", true);
          return;
        }
        state.isAdmin = !!resp.is_admin;
        updateUserInfoUI();

        document.querySelectorAll(".admin-only").forEach((el) => {
          if (state.isAdmin) el.classList.remove("hidden");
          else el.classList.add("hidden");
        });

        $("access-denied").classList.add("hidden");
        $("main").classList.remove("hidden");

        loadJobs(false);
        loadJobs(true);  // архив
        loadGroups();
        if (state.isAdmin) {
          loadAllowedUsers();
        }
      } catch (e) {
        console.error(e);
        showFlash("Ошибка /check_access: " + e.message, true);
        $("access-denied").classList.remove("hidden");
      }
    }

    // --------- Вакансии / архив ---------

    function renderJobs(containerId, jobs, archived) {
      const list = $(containerId);
      if (!jobs || !jobs.length) {
        list.innerHTML = '<div class="card muted">Пока ничего нет.</div>';
        return;
      }
      list.innerHTML = jobs.map((j) => {
        const srcName = escapeHtml(j.source_name || j.source || "");
        const url = escapeHtml(j.url || "");
        const sender = escapeHtml(j.sender_username || "");
        const created = formatDate(j.created_at);
        const received = formatDate(j.received_at);
        const linkHtml = url ? `<a href="${url}" target="_blank" rel="noopener noreferrer">Открыть пост</a>` : "";
        const archiveBtn = state.isAdmin
          ? `<button class="btn btn-outline btn-xs" data-job-id="${j.id}" data-archived="${archived ? "true" : "false"}">
               ${archived ? "Вернуть из архива" : "В архив"}
             </button>`
          : "";
        return `
          <div class="card">
            <div class="job">${escapeHtml(j.text || "")}</div>
            <div class="job-meta">
              <span class="badge">${srcName || "unknown"}</span>
              <span>Создано: ${created}</span>
              <span>Получено: ${received}</span>
              ${sender ? `<span>Автор: ${sender}</span>` : ""}
              ${linkHtml ? `<span>${linkHtml}</span>` : ""}
            </div>
            ${archiveBtn ? `<div class="job-actions">${archiveBtn}</div>` : ""}
          </div>`;
      }).join("");

      if (state.isAdmin) {
        list.querySelectorAll("button[data-job-id]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-job-id");
            const isArchived = btn.getAttribute("data-archived") === "true";
            try {
              await apiFetch(`/api/jobs/${id}/archive`, {
                method: "POST",
                admin: true,
                body: { archived: !isArchived },
              });
              showFlash("Статус вакансии обновлён");
              loadJobs(false);
              loadJobs(true);
            } catch (e) {
              console.error(e);
              showFlash("Ошибка архивирования: " + e.message, true);
            }
          });
        });
      }
    }

    async function loadJobs(archived) {
      const params = new URLSearchParams();
      params.set("limit", "50");
      params.set("archived", archived ? "true" : "false");
      try {
        const data = await apiFetch("/api/jobs?" + params.toString());
        const jobs = data.jobs || [];
        renderJobs(archived ? "archive-list" : "jobs-list", jobs, archived);
      } catch (e) {
        console.error(e);
        showFlash("Ошибка загрузки вакансий: " + e.message, true);
      }
    }

    // --------- Группы ---------

    async function loadGroups() {
      try {
        const data = await apiFetch("/api/groups");
        const groups = data.groups || [];
        const list = $("groups-list");
        if (!groups.length) {
          list.innerHTML = '<div class="card muted">Пока ни одной группы не добавлено.</div>';
          return;
        }
        list.innerHTML = groups.map((g) => {
          const id = g.id;
          const gid = g.group_id || "";
          const name = g.group_name || "";
          const enabled = !!g.enabled;
          const added = formatDate(g.added_at);
          return `
            <div class="card">
              <div class="list-item">
                <div>
                  <div class="list-main"><b>${escapeHtml(name || gid)}</b></div>
                  <div class="list-meta">
                    <span>group_id: ${escapeHtml(gid)}</span>
                    <span>Добавлено: ${added}</span>
                  </div>
                </div>
                <div class="text-right">
                  <div>
                    <label style="font-size:12px;">
                      <input type="checkbox" data-action="toggle" data-id="${id}" ${enabled ? "checked" : ""}/>
                      <span>${enabled ? "Включено" : "Выключено"}</span>
                    </label>
                  </div>
                  ${state.isAdmin ? `<button class="btn btn-danger" style="margin-top:6px;" data-action="delete" data-id="${id}">Удалить</button>` : ""}
                </div>
              </div>
            </div>`;
        }).join("");

        if (state.isAdmin) {
          list.querySelectorAll("input[data-action='toggle']").forEach((ch) => {
            ch.addEventListener("change", async () => {
              const id = ch.getAttribute("data-id");
              const enabled = ch.checked;
              try {
                await apiFetch(`/api/groups/${id}/toggle`, {
                  method: "POST",
                  admin: true,
                  body: { enabled },
                });
                showFlash("Статус группы обновлён");
                loadGroups();
              } catch (e) {
                console.error(e);
                showFlash("Ошибка обновления группы: " + e.message, true);
              }
            });
          });

          list.querySelectorAll("button[data-action='delete']").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-id");
              if (!confirm("Удалить группу?")) return;
              try {
                await apiFetch(`/api/groups/${id}`, {
                  method: "DELETE",
                  admin: true,
                });
                showFlash("Группа удалена");
                loadGroups();
              } catch (e) {
                console.error(e);
                showFlash("Ошибка удаления группы: " + e.message, true);
              }
            });
          });
        }
      } catch (e) {
        console.error(e);
        showFlash("Ошибка загрузки групп: " + e.message, true);
      }
    }

    // --------- Настройки / secrets ---------

    async function saveFbCookiesFull() {
      const raw = $("fb-cookies-json").value.trim();
      if (!raw) {
        showFlash("Вставь полный JSON cookies", true);
        return;
      }
      try {
        JSON.parse(raw);
      } catch (e) {
        showFlash("Некорректный JSON: " + e.message, true);
        return;
      }
      try {
        await apiFetch("/api/admin/fb_cookies", {
          method: "POST",
          admin: true,
          body: { cookies_json: raw },
        });
        showFlash("Полный JSON cookies сохранён");
      } catch (e) {
        console.error(e);
        showFlash("Ошибка сохранения cookies: " + e.message, true);
      }
    }

    async function saveFbCookiesDynamic() {
      const c_user = $("fb-cookies-c_user").value.trim();
      const xs    = $("fb-cookies-xs").value.trim();
      const fr    = $("fb-cookies-fr").value.trim();
      const datr  = $("fb-cookies-datr").value.trim();

      const parts = [];
      if (c_user) parts.push("c_user=" + c_user);
      if (xs)     parts.push("xs=" + xs);
      if (fr)     parts.push("fr=" + fr);
      if (datr)   parts.push("datr=" + datr);

      if (!parts.length) {
        showFlash("Введи хотя бы одно значение cookie (c_user/xs/fr/datr)", true);
        return;
      }

      const cookie_kv = parts.join("; ");

      try {
        await apiFetch("/api/admin/fb_cookies_dynamic", {
          method: "POST",
          admin: true,
          body: { cookie_kv },
        });
        showFlash("Динамичные значения cookies обновлены");
      } catch (e) {
        console.error(e);
        showFlash("Ошибка обновления cookies: " + e.message, true);
      }
    }

    async function saveTgSessionManual() {
      const session = $("tg-session-text").value.trim();
      if (!session) {
        showFlash("Вставь StringSession", true);
        return;
      }
      try {
        await apiFetch("/api/admin/tg_session", {
          method: "POST",
          admin: true,
          body: { session },
        });
        showFlash("Telegram StringSession сохранена");
      } catch (e) {
        console.error(e);
        showFlash("Ошибка сохранения StringSession: " + e.message, true);
      }
    }

    async function tgAuthStart() {
      const phone = $("tg-phone-input").value.trim();
      if (!phone) {
        showFlash("Введи телефон", true);
        return;
      }
      try {
        await apiFetch("/api/admin/tg_auth/start", {
          method: "POST",
          admin: true,
          body: { phone },
        });
        showFlash("Код отправлен в Telegram. Введи его ниже.");
        $("tg-auth-hint").textContent = "Код отправлен. Введи код и пароль 2FA (если есть) и нажми кнопку ниже.";
      } catch (e) {
        console.error(e);
        showFlash("Ошибка отправки кода: " + e.message, true);
      }
    }

    async function tgAuthConfirm() {
      const code = $("tg-code-input").value.trim();
      const password = $("tg-password-input").value.trim() || null;
      if (!code) {
        showFlash("Введи код из Telegram", true);
        return;
      }
      try {
        await apiFetch("/api/admin/tg_auth/confirm", {
          method: "POST",
          admin: true,
          body: { code, password },
        });
        showFlash("Telegram StringSession успешно создана и сохранена");
        $("tg-auth-hint").textContent = "";
        $("tg-code-input").value = "";
        $("tg-password-input").value = "";
      } catch (e) {
        console.error(e);
        showFlash("Ошибка подтверждения кода: " + e.message, true);
      }
    }

    // --------- Разрешённые пользователи ---------

    async function loadAllowedUsers() {
      try {
        const data = await apiFetch("/api/allowed_users", { admin: true });
        const users = data.users || [];
        const list = $("allowed-users-list");
        if (!users.length) {
          list.innerHTML = '<div class="muted">Список пуст.</div>';
          return;
        }
        list.innerHTML = users.map((u) => {
          const updated = formatDate(u.updated_at);
          return `
            <div class="list-item">
              <div>
                <div class="list-main"><b>@${escapeHtml(u.username)}</b></div>
                <div class="list-meta">
                  <span>ID: ${escapeHtml(u.user_id ?? "")}</span>
                  <span>Обновлено: ${updated}</span>
                </div>
              </div>
              <div>
                <button class="btn btn-danger" data-id="${u.id}">Удалить</button>
              </div>
            </div>`;
        }).join("");

        list.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (!confirm("Удалить пользователя из списка доступа?")) return;
            try {
              await apiFetch(`/api/allowed_users/${id}`, {
                method: "DELETE",
                admin: true,
              });
              showFlash("Пользователь удалён");
              loadAllowedUsers();
            } catch (e) {
              console.error(e);
              showFlash("Ошибка удаления пользователя: " + e.message, true);
            }
          });
        });
      } catch (e) {
        console.error(e);
        showFlash("Ошибка загрузки списка доступа: " + e.message, true);
      }
    }

    async function addAllowedUser() {
      const username = $("allowed-username-input").value.trim().replace(/^@/, "");
      if (!username) {
        showFlash("Введи username без @", true);
        return;
      }
      try {
        await apiFetch("/api/allowed_users", {
          method: "POST",
          admin: true,
          body: { username },
        });
        $("allowed-username-input").value = "";
        showFlash("Пользователь добавлен/обновлён");
        loadAllowedUsers();
      } catch (e) {
        console.error(e);
        showFlash("Ошибка добавления пользователя: " + e.message, true);
      }
    }

    // --------- Табы и инициализация ---------

    function initTabs() {
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const name = tab.getAttribute("data-tab");
          document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          document.querySelectorAll(".tab-page").forEach((p) => p.classList.add("hidden"));
          const page = $("tab-" + name);
          if (page) page.classList.remove("hidden");
        });
      });
    }

    function initEvents() {
      $("jobs-refresh-btn").addEventListener("click", () => loadJobs(false));
      $("archive-refresh-btn").addEventListener("click", () => loadJobs(true));

      $("group-add-btn").addEventListener("click", async () => {
        const gid = $("group-id-input").value.trim();
        const name = $("group-name-input").value.trim();
        if (!gid) {
          showFlash("Укажи group_id / URL", true);
          return;
        }
        try {
          await apiFetch("/api/groups", {
            method: "POST",
            admin: true,
            body: { group_id: gid, group_name: name },
          });
          $("group-id-input").value = "";
          $("group-name-input").value = "";
          showFlash("Группа добавлена/обновлена");
          loadGroups();
        } catch (e) {
          console.error(e);
          showFlash("Ошибка добавления группы: " + e.message, true);
        }
      });

      $("fb-cookies-json-btn").addEventListener("click", saveFbCookiesFull);
      $("fb-cookies-dynamic-btn").addEventListener("click", saveFbCookiesDynamic);
      $("tg-session-save-btn").addEventListener("click", saveTgSessionManual);
      $("tg-send-code-btn").addEventListener("click", tgAuthStart);
      $("tg-confirm-code-btn").addEventListener("click", tgAuthConfirm);
      $("allowed-add-btn").addEventListener("click", addAllowedUser);
    }

    function initTelegram() {
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        state.initData = tg.initData || "";
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
          state.user = tg.initDataUnsafe.user;
        }
        try {
          tg.ready();
          tg.expand();
        } catch (e) {
          console.warn("Telegram WebApp init error", e);
        }
      }
      updateUserInfoUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTabs();
      initEvents();
      initTelegram();
      checkAccess();
    });
  </script>
</body>
</html>
