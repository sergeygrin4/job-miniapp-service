<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Job MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #f2f3f5;
      color: #222;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
    }

    .app-user {
      font-size: 12px;
      color: #666;
      text-align: right;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #d0d4da;
      background: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    .tab-btn.active {
      background: #2a9df4;
      color: #fff;
      border-color: #2a9df4;
    }

    .tab {
      display: none;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #dcdfe5;
      padding: 10px;
    }

    .tab.active {
      display: block;
    }

    .flash {
      margin-bottom: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }

    .flash.show {
      display: block;
    }

    .flash-ok {
      background: #e6ffed;
      border: 1px solid #9ae6b4;
      color: #22543d;
    }

    .flash-err {
      background: #ffe6e6;
      border: 1px solid #feb2b2;
      color: #742a2a;
    }

    .section {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .section-subtitle {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .field {
      flex: 1 1 150px;
      min-width: 150px;
    }

    label {
      display: block;
      font-size: 11px;
      color: #555;
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="tel"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 5px 7px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #ccd0d5;
      outline: none;
    }

    input:focus,
    textarea:focus {
      border-color: #2a9df4;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 220px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      background: #2a9df4;
      color: #fff;
      white-space: nowrap;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #111827;
      border-color: #d1d5db;
    }

    .btn-danger {
      background: #f97373;
      border-color: #f97373;
      color: #fff;
    }

    .btn-group-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .small-text {
      font-size: 11px;
      color: #666;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .card {
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      background: #fff;
      overflow: hidden;
    }

    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .job-source {
      font-size: 11px;
      color: #555;
    }

    .job-source strong {
      font-weight: 600;
      color: #111;
    }

    .job-meta {
      font-size: 10px;
      color: #777;
      white-space: nowrap;
    }

    .job-text {
      font-size: 12px;
      margin-top: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
    }

    .job-links {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      font-size: 11px;
    }

    .link-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      background: #eff6ff;
      text-decoration: none;
      color: #1d4ed8;
      max-width: 100%;
      white-space: normal;
      word-break: break-word;
    }

    .link-pill .label {
      font-weight: 600;
    }

    a {
      color: #1d4ed8;
    }

    a:hover {
      text-decoration: underline;
    }

    .job-actions {
      margin-top: 4px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .group-card {
      font-size: 12px;
      word-wrap: break-word;
      word-break: break-word;
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: flex-start;
    }

    .group-title {
      font-weight: 600;
    }

    .group-title a {
      text-decoration: none;
      color: #111;
    }

    .group-title a:hover {
      text-decoration: underline;
    }

    .group-id {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
      word-break: break-all;
    }

    .group-meta {
      font-size: 10px;
      color: #666;
      white-space: nowrap;
    }

    .group-actions {
      margin-top: 4px;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
    }

    .status-on {
      border-color: #6ee7b7;
      background: #ecfdf5;
      color: #047857;
    }

    .status-off {
      color: #555;
    }

    .access-denied {
      padding: 20px;
      text-align: center;
      font-size: 14px;
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      display: inline-block;
      padding: 2px 4px;
      border-radius: 4px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="app-header">
    <div class="app-title">Job MiniApp</div>
    <div class="app-user" id="app-user-info">Загрузка…</div>
  </div>

  <div id="flash" class="flash"></div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="jobs">Вакансии</button>
    <button class="tab-btn" data-tab="groups">Группы</button>
    <button class="tab-btn" data-tab="settings" id="tab-btn-settings" style="display:none;">Настройки</button>
    <button class="tab-btn" data-tab="access" id="tab-btn-access" style="display:none;">Доступ</button>
    <button class="tab-btn" data-tab="archive">Архив</button>
  </div>

  <!-- Вакансии -->
  <div id="tab-jobs" class="tab active">
    <div class="section">
      <div class="section-title">
        Вакансии
        <span class="small-text" id="jobs-count"></span>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-secondary btn-sm" id="btn-reload-jobs">Обновить</button>
      </div>
      <div class="list" id="jobs-list"></div>
    </div>
  </div>

  <!-- Группы -->
  <div id="tab-groups" class="tab">
    <div class="section">
      <div class="section-title">Группы</div>
      <div class="section-subtitle">
        Список отсюда использует Telegram-парсер и FB-парсер.
      </div>
      <div class="field-row">
        <div class="field">
          <label>Новый источник (ID / URL)</label>
          <input type="text" id="group-id-input" placeholder="https://t.me/... или id группы FB" />
        </div>
        <div class="field">
          <label>Название (опционально)</label>
          <input type="text" id="group-name-input" placeholder="Как будем отображать" />
        </div>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-sm" id="btn-add-group">Добавить</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Список групп</div>
      <div id="groups-list" class="list"></div>
    </div>
  </div>

  <!-- Настройки -->
  <div id="tab-settings" class="tab">
    <div class="section">
      <div class="section-title">Состояние аккаунтов</div>
      <div class="section-subtitle" id="secrets-overview">Загрузка…</div>
    </div>

    <div class="section">
      <div class="section-title">Facebook cookies (Apify)</div>
      <div class="section-subtitle">
        1) Один раз сохрани полный <span class="code">JSON</span> cookies, который даёт Apify.<br/>
        2) Дальше обычно меняются только отдельные значения (например, <span class="code">xs</span>, <span class="code">sb</span>, <span class="code">fr</span>).
      </div>
      <div class="field">
        <label>Полный JSON cookies (при первичной настройке или если структура поменялась)</label>
        <textarea id="fb-cookies-json-input"
                  placeholder='[{"key":"c_user","value":"..."}, ...]'></textarea>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-sm" id="btn-save-fb-cookies-json">Сохранить полный JSON</button>
      </div>
      <hr style="margin:8px 0;border:none;border-top:1px solid #e5e7eb;">
      <div class="section-subtitle">
        Динамичные cookie (обновляем отдельные ключи):
      </div>
      <div class="field-row">
        <div class="field">
          <label>xs</label>
          <input type="text" id="fb-xs" placeholder="xs=..." />
        </div>
        <div class="field">
          <label>sb</label>
          <input type="text" id="fb-sb" placeholder="sb=..." />
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>fr</label>
          <input type="text" id="fb-fr" placeholder="fr=..." />
        </div>
        <div class="field">
          <label>c_user</label>
          <input type="text" id="fb-c_user" placeholder="c_user=..." />
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>datr</label>
          <input type="text" id="fb-datr" placeholder="datr=..." />
        </div>
        <div class="field">
          <label>spin</label>
          <input type="text" id="fb-spin" placeholder="spin=..." />
        </div>
      </div>
      <div class="field">
        <label>Дополнительно (формат <span class="code">k=v; k2=v2</span>)</label>
        <input type="text" id="fb-extra-kv" placeholder="wd=1920x1080; ..." />
      </div>
      <div class="btn-group-row">
        <button class="btn btn-sm" id="btn-save-fb-cookies-dynamic">Обновить значения cookies</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Telegram: StringSession (ручной ввод)</div>
      <div class="section-subtitle">
        Если у тебя уже есть StringSession (например, из локального скрипта), можно просто вставить её сюда.
      </div>
      <div class="field">
        <label>StringSession</label>
        <textarea id="tg-session-manual-input"
                  placeholder="1AAABbCc..."></textarea>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-secondary btn-sm" id="tg-save-session-manual-btn">Сохранить StringSession</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Telegram: полуавтоматический логин по коду</div>
      <div class="section-subtitle">
        Шаг 1 — вводишь номер, мы отправляем код через MiniApp-бекэнд.<br/>
        Шаг 2 — вводишь код и пароль 2FA (если есть), бекэнд сохранит новую StringSession.
      </div>
      <div class="field">
        <label>Телефон (+7999…)</label>
        <input type="tel" id="tg-phone-input" placeholder="+7..." />
      </div>
      <div class="btn-group-row">
        <button class="btn btn-sm" id="tg-send-code-btn">Отправить код</button>
        <span class="small-text" id="tg-auth-hint"></span>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Код из Telegram</label>
          <input type="text" id="tg-code-input" placeholder="12345" />
        </div>
        <div class="field">
          <label>Пароль 2FA (если включён)</label>
          <input type="password" id="tg-password-input" placeholder="опционально" />
        </div>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-sm" id="tg-confirm-code-btn">Подтвердить код, создать сессию</button>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-secondary btn-sm" id="tg-check-session-btn">Проверить текущую сессию</button>
        <span class="small-text" id="tg-check-session-result"></span>
      </div>
    </div>
  </div>

  <!-- Доступ -->
  <div id="tab-access" class="tab">
    <div class="section">
      <div class="section-title">Разрешённые пользователи</div>
      <div class="section-subtitle">
        Любой, кто открывает миниапп, сначала бьётся в <span class="code">/check_access</span>.
        Здесь можно управлять списком тех, кому есть доступ.
      </div>
      <div class="field-row">
        <div class="field">
          <label>username без @</label>
          <input type="text" id="allowed-username-input" placeholder="username" />
        </div>
        <div class="field" style="flex:0 0 auto;align-self:flex-end;">
          <button class="btn btn-sm" id="btn-add-allowed-user">Добавить</button>
        </div>
      </div>
      <div id="allowed-users-list" class="list"></div>
    </div>
  </div>

  <!-- Архив -->
  <div id="tab-archive" class="tab">
    <div class="section">
      <div class="section-title">
        Архив вакансий
        <span class="small-text" id="archive-count"></span>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-secondary btn-sm" id="btn-reload-archive">Обновить архив</button>
      </div>
      <div class="list" id="archive-list"></div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const appState = {
    initData: "",
    user: null,
    accessGranted: false,
    isAdmin: false,
  };

  function showFlash(msg, isError = false) {
    const box = $("flash");
    if (!box) return;
    box.textContent = msg;
    box.className = "flash show " + (isError ? "flash-err" : "flash-ok");
    setTimeout(() => {
      box.classList.remove("show");
    }, 4000);
  }

  async function apiFetch(path, opts = {}) {
    const { method = "GET", body = null, admin = false } = opts;

    const headers = {};
    if (body !== null) {
      headers["Content-Type"] = "application/json";
    }

    if (appState.initData) {
      headers["X-TG-INIT-DATA"] = appState.initData;
    }

    // Всегда, если знаем username, шлём как fallback для админ-эндпоинтов
    if (admin && appState.user && appState.user.username) {
      headers["X-ADMIN-USERNAME"] = appState.user.username;
    }

    const resp = await fetch(path, {
      method,
      headers,
      body: body !== null ? JSON.stringify(body) : null,
    });

    let data;
    try {
      data = await resp.json();
    } catch (e) {
      throw new Error("Некорректный ответ сервера");
    }

    if (!resp.ok) {
      const msg = data && data.error ? data.error : resp.statusText;
      throw new Error(msg);
    }
    return data;
  }

  function setUserInfo() {
    const el = $("app-user-info");
    if (!el) return;

    if (!appState.user) {
      el.textContent = "Нет данных пользователя";
      return;
    }

    const u = appState.user;
    const name = u.username
      ? "@" + u.username
      : (u.first_name || "") + (u.last_name ? " " + u.last_name : "");
    el.innerHTML = `<div><strong>${name}</strong></div><div class="small-text">id: ${u.id}</div>`;
  }

  function setupTabs() {
    const btns = document.querySelectorAll(".tab-btn");
    btns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        const target = $("tab-" + tab);
        if (target) target.classList.add("active");
      });
    });
  }

  async function bootstrapAccess() {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      appState.initData = tg.initData || "";
      appState.user = tg.initDataUnsafe && tg.initDataUnsafe.user
        ? tg.initDataUnsafe.user
        : null;
      try { tg.ready(); } catch (e) {}
    }

    setUserInfo();

    let userPayload = { user_id: null, username: null };
    if (appState.user) {
      userPayload.user_id = appState.user.id;
      userPayload.username = appState.user.username || "";
    }

    try {
      const res = await apiFetch("/check_access", {
        method: "POST",
        body: userPayload,
      });
      appState.accessGranted = !!res.access_granted;
      appState.isAdmin = !!res.is_admin;
    } catch (e) {
      console.error(e);
      appState.accessGranted = false;
      appState.isAdmin = false;
    }

    if (!appState.accessGranted) {
      document.body.innerHTML = `
        <div class="app">
          <div class="access-denied">
            Доступ к миниаппу закрыт.<br/>
            Обратиться к администратору для добавления username.
          </div>
        </div>
      `;
      return;
    }

    if (appState.isAdmin) {
      $("tab-btn-settings").style.display = "";
      $("tab-btn-access").style.display = "";
    } else {
      $("tab-btn-settings").style.display = "none";
      $("tab-btn-access").style.display = "none";
    }

    await Promise.all([
      loadJobs(),
      loadArchive(),
      loadGroups(),
    ]);

    if (appState.isAdmin) {
      await Promise.all([
        loadAllowedUsers(),
        loadSecretsOverview(),
      ]);
    }
  }

  async function loadJobs() {
    try {
      const res = await apiFetch("/api/jobs?limit=50&archived=false");
      const jobs = res.jobs || [];
      $("jobs-count").textContent = jobs.length ? `(${jobs.length})` : "";
      const list = $("jobs-list");
      list.innerHTML = "";
      jobs.forEach((j) => list.appendChild(renderJobCard(j, false)));
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки вакансий: " + e.message, true);
    }
  }

  async function loadArchive() {
    try {
      const res = await apiFetch("/api/jobs?limit=50&archived=true");
      const jobs = res.jobs || [];
      $("archive-count").textContent = jobs.length ? `(${jobs.length})` : "";
      const list = $("archive-list");
      list.innerHTML = "";
      jobs.forEach((j) => list.appendChild(renderJobCard(j, true)));
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки архива: " + e.message, true);
    }
  }

  function renderJobCard(job, archived) {
    const card = document.createElement("div");
    card.className = "card";

    const header = document.createElement("div");
    header.className = "job-header";

    const src = document.createElement("div");
    src.className = "job-source";
    const sourceName = job.source_name || job.source || "";
    src.innerHTML = `<strong>${sourceName}</strong>`;
    header.appendChild(src);

    const meta = document.createElement("div");
    meta.className = "job-meta";
    const created = job.created_at ? new Date(job.created_at) : null;
    const received = job.received_at ? new Date(job.received_at) : null;
    let metaText = "";
    if (created) metaText += created.toLocaleString("ru-RU");
    if (received) metaText += (metaText ? " · " : "") + "получено " + received.toLocaleTimeString("ru-RU");
    meta.textContent = metaText;
    header.appendChild(meta);

    card.appendChild(header);

    const body = document.createElement("div");
    body.className = "job-text";
    body.textContent = job.text || "";
    card.appendChild(body);

    const linksRow = document.createElement("div");
    linksRow.className = "job-links";

    if (job.url) {
      const a = document.createElement("a");
      a.className = "link-pill";
      a.href = job.url;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.innerHTML = `<span class="label">Группа:</span> <span>${job.source_name || "перейти"}</span>`;
      linksRow.appendChild(a);
    }

    if (job.sender_username) {
      const uname = job.sender_username.replace(/^@/, "");
      const profileUrl = job.source === "tg"
        ? `https://t.me/${uname}`
        : (job.url || "#");
      const a = document.createElement("a");
      a.className = "link-pill";
      a.href = profileUrl;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.innerHTML = `<span class="label">Автор:</span> <span>@${uname}</span>`;
      linksRow.appendChild(a);
    }

    if (linksRow.children.length) {
      card.appendChild(linksRow);
    }

    const actions = document.createElement("div");
    actions.className = "job-actions";

    const btn = document.createElement("button");
    btn.className = "btn btn-secondary btn-sm";
    if (!archived) {
      btn.textContent = "В архив";
      btn.addEventListener("click", async () => {
        try {
          await apiFetch(`/api/jobs/${job.id}/archive`, {
            method: "POST",
            admin: true,
            body: { archived: true },
          });
          showFlash("Вакансия отправлена в архив");
          await loadJobs();
          await loadArchive();
        } catch (e) {
          console.error(e);
          showFlash("Не удалось архивировать: " + e.message, true);
        }
      });
    } else {
      btn.textContent = "Вернуть из архива";
      btn.addEventListener("click", async () => {
        try {
          await apiFetch(`/api/jobs/${job.id}/archive`, {
            method: "POST",
            admin: true,
            body: { archived: false },
          });
          showFlash("Вакансия возвращена");
          await loadJobs();
          await loadArchive();
        } catch (e) {
          console.error(e);
          showFlash("Не удалось вернуть: " + e.message, true);
        }
      });
    }
    actions.appendChild(btn);
    card.appendChild(actions);

    return card;
  }

  async function loadGroups() {
    try {
      const res = await apiFetch("/api/groups");
      const groups = res.groups || [];
      const list = $("groups-list");
      list.innerHTML = "";

      if (!groups.length) {
        const div = document.createElement("div");
        div.className = "small-text";
        div.textContent = "Групп пока нет.";
        list.appendChild(div);
        return;
      }

      groups.forEach((g) => {
        const card = document.createElement("div");
        card.className = "card group-card";

        const header = document.createElement("div");
        header.className = "group-header";

        const titleBlock = document.createElement("div");
        const groupName = g.group_name || g.group_id || "Группа";
        const href = (g.group_id || "").startsWith("http")
          ? g.group_id
          : g.group_id
            ? `https://facebook.com/groups/${g.group_id}`
            : "#";

        const nameEl = document.createElement("div");
        nameEl.className = "group-title";
        const nameLink = document.createElement("a");
        nameLink.href = href;
        nameLink.target = "_blank";
        nameLink.rel = "noopener noreferrer";
        nameLink.textContent = groupName;
        nameEl.appendChild(nameLink);

        const idEl = document.createElement("div");
        idEl.className = "group-id";
        idEl.textContent = g.group_id || "";
        nameEl.appendChild(idEl);

        titleBlock.appendChild(nameEl);
        header.appendChild(titleBlock);

        const meta = document.createElement("div");
        meta.className = "group-meta";
        const status = document.createElement("span");
        status.className = "status-pill " + (g.enabled ? "status-on" : "status-off");
        status.textContent = g.enabled ? "Включено" : "Выключено";
        meta.appendChild(status);
        header.appendChild(meta);

        card.appendChild(header);

        const actions = document.createElement("div");
        actions.className = "group-actions";

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "btn btn-secondary btn-sm";
        toggleBtn.textContent = g.enabled ? "Выключить" : "Включить";
        toggleBtn.addEventListener("click", async () => {
          try {
            await apiFetch(`/api/groups/${g.id}/toggle`, {
              method: "POST",
              admin: true,
              body: { enabled: !g.enabled },
            });
            await loadGroups();
          } catch (e) {
            console.error(e);
            showFlash("Ошибка изменения статуса группы: " + e.message, true);
          }
        });
        actions.appendChild(toggleBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-sm";
        delBtn.textContent = "Удалить";
        delBtn.addEventListener("click", async () => {
          if (!confirm("Удалить эту группу?")) return;
          try {
            await apiFetch(`/api/groups/${g.id}`, {
              method: "DELETE",
              admin: true,
            });
            await loadGroups();
          } catch (e) {
            console.error(e);
            showFlash("Ошибка удаления группы: " + e.message, true);
          }
        });
        actions.appendChild(delBtn);

        card.appendChild(actions);
        list.appendChild(card);
      });
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки групп: " + e.message, true);
    }
  }

  async function addGroup() {
    const groupId = $("group-id-input").value.trim();
    const groupName = $("group-name-input").value.trim();
    if (!groupId) {
      showFlash("Укажи ссылку или ID группы", true);
      return;
    }
    try {
      await apiFetch("/api/groups", {
        method: "POST",
        admin: true,
        body: { group_id: groupId, group_name: groupName },
      });
      $("group-id-input").value = "";
      $("group-name-input").value = "";
      await loadGroups();
      showFlash("Группа сохранена");
    } catch (e) {
      console.error(e);
      showFlash("Не удалось сохранить группу: " + e.message, true);
    }
  }

 // --- FB cookies: полный JSON ---
async function saveFbCookiesJson() {
  const txt = $("fb-cookies-json-input").value.trim();
  if (!txt) {
    showFlash("Вставь JSON cookies", true);
    return;
  }
  try {
    await apiFetch("/api/admin/fb_cookies", {
      method: "POST",
      admin: true,
      body: { cookies_json: txt }, // <- ключ меняем на cookies_json
    });
    showFlash("FB cookies JSON сохранён");
  } catch (e) {
    console.error(e);
    showFlash("Ошибка сохранения FB cookies JSON: " + e.message, true);
  }
}


  // --- FB cookies: динамичные значения ---
  async function saveFbCookiesDynamic() {
    try {
      const dynamicMap = {};

      function addKey(key, rawVal) {
        if (!rawVal) return;
        let v = rawVal.trim();
        if (!v) return;
        // разрешаем вводить и "xs=..." и просто "..."
        const eqIdx = v.indexOf("=");
        if (eqIdx > 0) {
          v = v.slice(eqIdx + 1).trim();
        }
        if (!v) return;
        dynamicMap[key] = v;
      }

      addKey("xs", $("fb-xs").value);
      addKey("sb", $("fb-sb").value);
      addKey("fr", $("fb-fr").value);
      addKey("c_user", $("fb-c_user").value);
      addKey("datr", $("fb-datr").value);
      addKey("spin", $("fb-spin").value);

      const extra = $("fb-extra-kv").value.trim();
      if (extra) {
        extra.split(";").forEach((chunk) => {
          const p = chunk.trim();
          if (!p) return;
          const eqIdx = p.indexOf("=");
          if (eqIdx <= 0) return;
          const k = p.slice(0, eqIdx).trim();
          const v = p.slice(eqIdx + 1).trim();
          if (!k || !v) return;
          dynamicMap[k] = v;
        });
      }

      const dynKeys = Object.keys(dynamicMap);
      if (!dynKeys.length) {
        showFlash("Заполни xs/sb/fr/c_user или extra в формате key=value", true);
        return;
      }

      // тянем сохранённый полный JSON
      const secretRes = await fetch("/api/parser_secrets/fb_cookies_json");
      if (!secretRes.ok) {
        showFlash("Не удалось получить сохранённые cookies (fb_cookies_json)", true);
        console.error("fb_cookies_json status", secretRes.status, await secretRes.text());
        return;
      }
      const secretData = await secretRes.json();
      let storedJson = secretData.value;
      if (!storedJson) {
        showFlash('Сначала вставь ПОЛНЫЙ JSON cookies из Apify и нажми "Сохранить полный JSON".', true);
        return;
      }

      let cookies;
      try {
        cookies = JSON.parse(storedJson);
      } catch (e) {
        console.error("fb_cookies_json parse error", e, storedJson);
        showFlash("Сохранённый JSON cookies повреждён. Вставь корректный полный JSON из Apify и сохрани его ещё раз.", true);
        return;
      }

      if (!Array.isArray(cookies)) {
        console.error("fb_cookies_json is not array", cookies);
        showFlash('Ожидался массив cookies в JSON (формат: [{"key":"c_user","value":"..."}, ...]).', true);
        return;
      }

      let matched = 0;
      const cookieKeys = [];
      for (const c of cookies) {
        const key = (c.key || c.name || "").trim();
        if (!key) continue;
        cookieKeys.push(key);
        if (Object.prototype.hasOwnProperty.call(dynamicMap, key)) {
          c.value = dynamicMap[key];
          matched++;
        }
      }

      if (!matched) {
        console.warn("FB dynamic cookies: no keys matched", { dynKeys, cookieKeys });
        showFlash(
          "Не удалось сопоставить ни один cookie.\n" +
          "Проверь, что в полном JSON есть те же ключи (xs, sb, fr, c_user и т.п.).",
          true
        );
        return;
      }

            const newJson = JSON.stringify(cookies);

      await apiFetch("/api/admin/fb_cookies", {
        method: "POST",
        admin: true,
        body: { cookies_json: newJson }, // <- тоже cookies_json
      });

      showFlash(`Динамичные cookies обновлены (обновлено полей: ${matched}).`);

    }
  }

  async function loadAllowedUsers() {
    try {
      const res = await apiFetch("/api/allowed_users", { admin: true });
      const users = res.users || [];
      const list = $("allowed-users-list");
      list.innerHTML = "";
      if (!users.length) {
        const div = document.createElement("div");
        div.className = "small-text";
        div.textContent = "Пока нет дополнительных пользователей.";
        list.appendChild(div);
        return;
      }

      users.forEach((u) => {
        const card = document.createElement("div");
        card.className = "card";
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.alignItems = "center";
        row.style.gap = "6px";

        const info = document.createElement("div");
        info.style.fontSize = "12px";
        info.style.wordBreak = "break-word";
        const line1 = document.createElement("div");
        line1.textContent = u.username;
        const line2 = document.createElement("div");
        line2.className = "small-text";
        line2.textContent = "id: " + (u.user_id || "—");
        info.appendChild(line1);
        info.appendChild(line2);

        const btn = document.createElement("button");
        btn.className = "btn btn-danger btn-sm";
        btn.textContent = "Удалить";
        btn.addEventListener("click", async () => {
          if (!confirm("Удалить пользователя из списка доступа?")) return;
          try {
            await apiFetch(`/api/allowed_users/${u.id}`, {
              method: "DELETE",
              admin: true,
            });
            await loadAllowedUsers();
          } catch (e) {
            console.error(e);
            showFlash("Ошибка удаления пользователя: " + e.message, true);
          }
        });

        row.appendChild(info);
        row.appendChild(btn);
        card.appendChild(row);
        list.appendChild(card);
      });
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки списка доступа: " + e.message, true);
    }
  }

  async function addAllowedUser() {
    const username = $("allowed-username-input").value.trim().replace(/^@/, "");
    if (!username) {
      showFlash("Укажи username", true);
      return;
    }
    try {
      await apiFetch("/api/allowed_users", {
        method: "POST",
        admin: true,
        body: { username },
      });
      $("allowed-username-input").value = "";
      await loadAllowedUsers();
      showFlash("Пользователь добавлён");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка добавления пользователя: " + e.message, true);
    }
  }

  async function tgAuthStart() {
    const phone = $("tg-phone-input").value.trim();
    if (!phone) {
      showFlash("Введи телефон для Telegram", true);
      return;
    }
    try {
      await apiFetch("/api/admin/tg_auth/start", {
        method: "POST",
        admin: true,
        body: { phone },
      });
      $("tg-auth-hint").textContent = "Код отправлен. Проверь Telegram / SMS.";
      showFlash("Запрос кода отправлен");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка отправки кода: " + e.message, true);
    }
  }

  async function tgAuthConfirm() {
    const phone = $("tg-phone-input").value.trim();
    const code = $("tg-code-input").value.trim();
    const password = $("tg-password-input").value.trim() || null;

    if (!phone) {
      showFlash("Введи телефон", true);
      return;
    }
    if (!code) {
      showFlash("Введи код из Telegram", true);
      return;
    }

    try {
      await apiFetch("/api/admin/tg_auth/confirm", {
        method: "POST",
        admin: true,
        body: { phone, code, password },
      });
      showFlash("Telegram StringSession успешно создана и сохранена");
      $("tg-auth-hint").textContent = "";
      $("tg-code-input").value = "";
      $("tg-password-input").value = "";
    } catch (e) {
      console.error(e);
      showFlash("Ошибка подтверждения кода: " + e.message, true);
    }
  }

  async function tgSaveSessionManual() {
    const session = $("tg-session-manual-input").value.trim();
    if (!session) {
      showFlash("Вставь StringSession", true);
      return;
    }
    try {
      await apiFetch("/api/admin/tg_session", {
        method: "POST",
        admin: true,
        body: { session },
      });
      showFlash("StringSession сохранена");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка сохранения StringSession: " + e.message, true);
    }
  }

  async function tgCheckSession() {
    try {
      const res = await apiFetch("/api/admin/tg_session/check", { admin: true });
      const el = $("tg-check-session-result");
      if (!res.ok) {
        el.textContent = "Сессия неактивна: " + (res.reason || "unknown");
        el.style.color = "#b91c1c";
      } else {
        const me = res.me || {};
        const uname = me.username ? `@${me.username}` : (me.first_name || "аккаунт");
        el.textContent = "Сессия активна: " + uname;
        el.style.color = "#15803d";
      }
    } catch (e) {
      console.error(e);
      showFlash("Ошибка проверки сессии: " + e.message, true);
    }
  }

  async function loadSecretsOverview() {
    try {
      const res = await apiFetch("/api/admin/secrets", { admin: true });
      const el = $("secrets-overview");
      const fb = res.fb_cookies_updated_at
        ? new Date(res.fb_cookies_updated_at).toLocaleString("ru-RU")
        : "—";
      const tg = res.tg_session_updated_at
        ? new Date(res.tg_session_updated_at).toLocaleString("ru-RU")
        : "—";
      const pending = res.tg_auth_pending;

      el.innerHTML = `
        <div>FB cookies обновлены: <strong>${fb}</strong></div>
        <div>TG сессия обновлена: <strong>${tg}</strong></div>
        ${
          pending
            ? `<div class="small-text" style="margin-top:4px;">Незавершённая авторизация: ${JSON.stringify(
                pending
              )}</div>`
            : ""
        }
      `;
    } catch (e) {
      console.error(e);
      $("secrets-overview").textContent = "Ошибка загрузки статусов.";
    }
  }

  function initEvents() {
    $("btn-reload-jobs").addEventListener("click", loadJobs);
    $("btn-reload-archive").addEventListener("click", loadArchive);
    $("btn-add-group").addEventListener("click", addGroup);
    $("btn-save-fb-cookies-json").addEventListener("click", saveFbCookiesJson);
    $("btn-save-fb-cookies-dynamic").addEventListener("click", saveFbCookiesDynamic);
    $("btn-add-allowed-user").addEventListener("click", addAllowedUser);
    $("tg-send-code-btn").addEventListener("click", tgAuthStart);
    $("tg-confirm-code-btn").addEventListener("click", tgAuthConfirm);
    $("tg-save-session-manual-btn").addEventListener("click", tgSaveSessionManual);
    $("tg-check-session-btn").addEventListener("click", tgCheckSession);
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupTabs();
    initEvents();
    bootstrapAccess();
  });
</script>
</body>
</html>
