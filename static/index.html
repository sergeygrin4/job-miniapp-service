<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Job Miniapp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115;
      --bg-alt: #161920;
      --card-bg: #181c24;
      --accent: #2d8cff;
      --accent-soft: #203a5c;
      --danger: #ff4d4f;
      --text: #f5f5f7;
      --text-muted: #9298a6;
      --border: #262a35;
      --radius: 10px;
      --transition: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: radial-gradient(circle at top, #1a2333 0, #05060a 55%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 10px 18px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title span.logo-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(45, 140, 255, 0.8);
    }

    .app-user {
      font-size: 12px;
      color: var(--text-muted);
      text-align: right;
    }

    .app-user strong {
      color: var(--text);
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .tab-btn {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(12, 14, 20, 0.8);
      color: var(--text-muted);
      padding: 5px 12px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
      transition: background var(--transition), color var(--transition), border-color var(--transition), box-shadow var(--transition), transform var(--transition);
    }

    .tab-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: transparent;
    }

    .tab-btn.active {
      color: var(--text);
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(45, 140, 255, 0.3), rgba(23, 28, 40, 0.9));
      box-shadow: 0 0 18px rgba(45, 140, 255, 0.35);
    }

    .tab-btn.active span.dot {
      background: #fff;
    }

    .tab-btn:hover {
      transform: translateY(-0.5px);
      border-color: var(--accent-soft);
    }

    .tab {
      display: none;
      background: rgba(5, 7, 12, 0.85);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px;
    }

    .tab.active {
      display: block;
    }

    .flash {
      margin-bottom: 8px;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      display: none;
      word-wrap: break-word;
      word-break: break-word;
    }

    .flash.show {
      display: block;
    }

    .flash-ok {
      background: rgba(0, 128, 0, 0.08);
      border-color: rgba(0, 128, 0, 0.3);
      color: #c6f6d5;
    }

    .flash-err {
      background: rgba(255, 77, 79, 0.08);
      border-color: rgba(255, 77, 79, 0.4);
      color: #ffd6d6;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 6px 0 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .section-title small {
      font-weight: 400;
      color: var(--text-muted);
      font-size: 11px;
    }

    .section {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(17, 20, 30, 0.95), rgba(7, 10, 18, 0.95));
      border: 1px solid var(--border);
    }

    .section + .section {
      margin-top: 8px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .field {
      flex: 1 1 120px;
      min-width: 120px;
    }

    label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    input[type="text"],
    input[type="tel"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 5px 7px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(7, 9, 15, 0.95);
      color: var(--text);
      font-size: 12px;
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition), background var(--transition);
    }

    textarea {
      resize: vertical;
      min-height: 64px;
      max-height: 200px;
      line-height: 1.4;
    }

    input::placeholder,
    textarea::placeholder {
      color: #545b6b;
    }

    input:focus,
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(45, 140, 255, 0.3);
      background: rgba(8, 10, 18, 0.98);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
      max-width: 100%;
      white-space: normal;
      text-align: center;
    }

    .btn:hover {
      background: #2570d3;
      box-shadow: 0 0 12px rgba(45, 140, 255, 0.5);
      transform: translateY(-0.5px);
    }

    .btn-secondary {
      background: rgba(32, 36, 52, 0.9);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(45, 49, 66, 0.95);
      box-shadow: none;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #ff3335;
      box-shadow: 0 0 12px rgba(255, 77, 79, 0.5);
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
    }

    .btn-group-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .card {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      padding: 7px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow: hidden;
    }

    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .job-source {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .job-source strong {
      color: var(--text);
      font-weight: 500;
    }

    .job-meta {
      font-size: 10px;
      color: #6b7280;
      text-align: right;
      flex-shrink: 0;
    }

    .job-text {
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
    }

    .job-links {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
      font-size: 11px;
    }

    .link-pill {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.12);
      border: 1px solid rgba(37, 99, 235, 0.38);
      color: #bfdbfe;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      max-width: 100%;
      white-space: normal;
      word-break: break-word;
    }

    .link-pill span.label {
      font-weight: 500;
    }

    .link-pill:hover {
      background: rgba(37, 99, 235, 0.22);
    }

    a {
      color: #bfdbfe;
    }

    a:hover {
      color: #e5f2ff;
    }

    .group-card {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      word-wrap: break-word;
      word-break: break-word;
    }

    .group-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .group-title {
      font-weight: 500;
      font-size: 12px;
      line-height: 1.3;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .group-title a {
      color: #dbeafe;
      text-decoration: none;
    }

    .group-title a:hover {
      text-decoration: underline;
    }

    .group-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .group-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }

    .status-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.7);
    }

    .status-pill.on {
      border-color: rgba(52, 211, 153, 0.7);
      background: rgba(6, 95, 70, 0.7);
      color: #bbf7d0;
    }

    .status-pill.off {
      border-color: rgba(148, 163, 184, 0.5);
      background: rgba(55, 65, 81, 0.7);
      color: #e5e7eb;
    }

    .small-muted {
      font-size: 10px;
      color: var(--text-muted);
    }

    .two-cols {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 8px;
    }

    @media (max-width: 720px) {
      .two-cols {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .settings-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 8px;
    }

    @media (max-width: 820px) {
      .settings-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .settings-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin: 2px 0 6px;
    }

    .code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #020617;
      border-radius: 6px;
      padding: 3px 4px;
      border: 1px solid #1f2937;
      display: inline-block;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: var(--text-muted);
    }

    .pill strong {
      color: var(--text);
      font-weight: 500;
    }

    .access-denied {
      padding: 16px 10px;
      text-align: center;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="app-header">
    <div class="app-title">
      <span class="logo-dot"></span>
      <span>Job Parser Panel</span>
    </div>
    <div class="app-user" id="app-user-info">
      Загрузка профиля…
    </div>
  </div>

  <div id="flash" class="flash"></div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="jobs">
      <span class="dot"></span>
      Вакансии
    </button>
    <button class="tab-btn" data-tab="archive">
      <span class="dot"></span>
      Архив
    </button>
    <button class="tab-btn" data-tab="groups">
      <span class="dot"></span>
      Группы
    </button>
    <button class="tab-btn" data-tab="settings" id="tab-btn-settings" style="display:none;">
      <span class="dot"></span>
      Настройки
    </button>
  </div>

  <div id="tab-jobs" class="tab active">
    <div class="two-cols">
      <div>
        <div class="section-title">
          Вакансии
          <small id="jobs-count"></small>
        </div>
        <div class="section">
          <div class="small-muted">
            Здесь последние вакансии, собранные из групп Telegram / Facebook.
          </div>
          <div id="jobs-list" class="list"></div>
        </div>
      </div>
      <div>
        <div class="section-title">
          Быстрые действия
        </div>
        <div class="section">
          <div class="small-muted">
            Отмечай обработанные вакансии как <strong>архив</strong>, чтобы они не мешались в общем списке.
          </div>
          <div class="field-row" style="margin-top:6px;">
            <button class="btn btn-secondary btn-sm" id="btn-reload-jobs">
              Обновить список
            </button>
          </div>
          <div class="section" style="margin-top:8px;">
            <div class="section-title" style="margin-top:0;">
              Подсказка по ссылкам
            </div>
            <div class="small-muted">
              <strong>Группа:</strong> клик по названию откроет её в Telegram / Facebook.<br/>
              <strong>Автор:</strong> клик по имени откроет профиль.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-archive" class="tab">
    <div class="section-title">
      Архив вакансий
      <small id="archive-count"></small>
    </div>
    <div class="section">
      <div class="field-row" style="margin-bottom:8px;">
        <button class="btn btn-secondary btn-sm" id="btn-reload-archive">
          Обновить архив
        </button>
      </div>
      <div id="archive-list" class="list"></div>
    </div>
  </div>

  <div id="tab-groups" class="tab">
    <div class="section-title">
      Группы
      <small>Facebook / Telegram — для парсера</small>
    </div>
    <div class="section">
      <div class="field-row">
        <div class="field">
          <label>Ссылка на группу или ID</label>
          <input type="text" id="group-id-input" placeholder="https://facebook.com/groups/..." />
        </div>
        <div class="field">
          <label>Название группы</label>
          <input type="text" id="group-name-input" placeholder="Junior / Middle jobs ..." />
        </div>
      </div>
      <div class="btn-group-row">
        <button class="btn btn-sm" id="btn-add-group">
          Добавить / включить группу
        </button>
        <span class="small-muted">
          Для Telegram можно указывать ссылку вида <span class="code">https://t.me/groupname</span>.
        </span>
      </div>
    </div>

    <div class="section" style="margin-top:8px;">
      <div class="section-title" style="margin-top:0;">
        Список групп
      </div>
      <div id="groups-list" class="list"></div>
    </div>
  </div>

  <div id="tab-settings" class="tab">
    <div class="settings-grid">
      <div>
        <div class="section-title">
          Facebook cookies
        </div>

        <div class="section">
          <div class="settings-subtitle">
            Базовый JSON cookies (статическая часть). Эти данные редко меняются.
          </div>
          <div class="field">
            <label>JSON-массив cookies</label>
            <textarea id="fb-cookies-json-input"
                      placeholder='[{"domain":".facebook.com","name":"c_user","value":"..."}, ...]'></textarea>
          </div>
          <div class="btn-group-row">
            <button class="btn btn-sm" id="btn-save-fb-cookies-json">
              Сохранить полный JSON cookies
            </button>
            <span class="small-muted">
              Формат ровно такой же, как экспортирует браузер.
            </span>
          </div>
        </div>

        <div class="section">
          <div class="settings-subtitle">
            Динамичные значения cookies. Обычно меняются чаще всего (после перелогина).
          </div>
          <div class="field-row">
            <div class="field">
              <label>xs</label>
              <input type="text" id="fb-xs" placeholder="xs=..." />
            </div>
            <div class="field">
              <label>sb</label>
              <input type="text" id="fb-sb" placeholder="sb=..." />
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label>fr</label>
              <input type="text" id="fb-fr" placeholder="fr=..." />
            </div>
            <div class="field">
              <label>c_user</label>
              <input type="text" id="fb-c_user" placeholder="c_user=..." />
            </div>
          </div>
          <div class="field-row">
            <div class="field">
              <label>datr</label>
              <input type="text" id="fb-datr" placeholder="datr=..." />
            </div>
            <div class="field">
              <label>spin</label>
              <input type="text" id="fb-spin" placeholder="spin=..." />
            </div>
          </div>
          <div class="field">
            <label>Дополнительно (k=v; k2=v2)</label>
            <input type="text" id="fb-extra-kv" placeholder="wd=1920x1080; ..." />
          </div>
          <div class="btn-group-row">
            <button class="btn btn-sm" id="btn-save-fb-cookies-dynamic">
              Обновить только динамичные cookies
            </button>
            <span class="small-muted">
              Мы обновим только указанные ключи, остальные из JSON останутся без изменений.
            </span>
          </div>
        </div>

        <div class="section">
          <div class="section-title" style="margin-top:0;">
            Доступ пользователей
          </div>
          <div class="settings-subtitle">
            Здесь можно открыть доступ к миниаппу другим username.
          </div>
          <div class="field-row">
            <div class="field">
              <label>Username (без @)</label>
              <input type="text" id="allowed-username-input" placeholder="username" />
            </div>
            <div class="field" style="flex:0 0 auto;align-self:flex-end;">
              <button class="btn btn-sm" id="btn-add-allowed-user">
                Добавить
              </button>
            </div>
          </div>
          <div id="allowed-users-list" class="list"></div>
        </div>
      </div>

      <div>
        <div class="section-title">
          Telegram аккаунт
        </div>

        <div class="section">
          <div class="settings-subtitle">
            Полуавтоматическое поднятие сессии через номер телефона.
          </div>
          <div class="field">
            <label>Телефон (+7999…)</label>
            <input type="tel" id="tg-phone-input" placeholder="+48..." />
          </div>
          <div class="btn-group-row">
            <button class="btn btn-sm" id="tg-send-code-btn">
              Отправить код
            </button>
            <span class="small-muted" id="tg-auth-hint">
              Код придёт в Telegram / SMS (решает Telegram).
            </span>
          </div>
          <div class="field-row" style="margin-top:8px;">
            <div class="field">
              <label>Код из Telegram</label>
              <input type="text" id="tg-code-input" placeholder="12345" />
            </div>
            <div class="field">
              <label>Пароль 2FA (если есть)</label>
              <input type="password" id="tg-password-input" placeholder="••••••••" />
            </div>
          </div>
          <div class="btn-group-row">
            <button class="btn btn-sm" id="tg-confirm-code-btn">
              Подтвердить код и сохранить сессию
            </button>
          </div>
        </div>

        <div class="section">
          <div class="settings-subtitle">
            Ручной ввод Telegram <span class="code">StringSession</span>.
          </div>
          <div class="field">
            <label>StringSession</label>
            <textarea id="tg-session-manual-input"
                      placeholder="1AAABbCcDdEe... (сгенерировано Telethon-скриптом)"></textarea>
          </div>
          <div class="btn-group-row">
            <button class="btn btn-secondary btn-sm" id="tg-save-session-manual-btn">
              Сохранить StringSession вручную
            </button>
          </div>
        </div>

        <div class="section">
          <div class="settings-subtitle">
            Проверка текущей Telegram-сессии.
          </div>
          <div class="btn-group-row">
            <button class="btn btn-secondary btn-sm" id="tg-check-session-btn">
              Проверить текущую сессию
            </button>
            <span class="small-muted" id="tg-check-session-result"></span>
          </div>
        </div>

        <div class="section">
          <div class="section-title" style="margin-top:0;">
            Статусы парсеров
          </div>
          <div class="settings-subtitle">
            Краткая информация по последним статусам парсеров и секретам.
          </div>
          <div id="secrets-overview" class="small-muted">
            Загрузка…
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const appState = {
    initData: "",
    user: null,
    accessGranted: false,
    isAdmin: false,
  };

  function showFlash(msg, isError = false) {
    const box = $("flash");
    if (!box) return;
    box.textContent = msg;
    box.className = "flash show " + (isError ? "flash-err" : "flash-ok");
    setTimeout(() => {
      box.classList.remove("show");
    }, 4000);
  }

  async function apiFetch(path, opts = {}) {
    const {
      method = "GET",
      body = null,
      admin = false,
    } = opts;

    const headers = {};
    if (body !== null) {
      headers["Content-Type"] = "application/json";
    }
    if (appState.initData) {
      headers["X-TG-INIT-DATA"] = appState.initData;
    }
    // Для отладки вне Telegram можно руками подставить X-ADMIN-USERNAME
    if (admin && !appState.initData && appState.user && appState.user.username) {
      headers["X-ADMIN-USERNAME"] = appState.user.username;
    }

    const resp = await fetch(path, {
      method,
      headers,
      body: body !== null ? JSON.stringify(body) : null,
    });

    let data;
    try {
      data = await resp.json();
    } catch (e) {
      throw new Error("Некорректный ответ сервера");
    }

    if (!resp.ok) {
      const msg = data && data.error ? data.error : resp.statusText;
      throw new Error(msg);
    }
    return data;
  }

  function setUserInfo() {
    const el = $("app-user-info");
    if (!el) return;

    if (!appState.user) {
      el.textContent = "Нет данных пользователя";
      return;
    }

    const u = appState.user;
    const name = u.username || (u.first_name ? (u.first_name + (u.last_name ? " " + u.last_name : "")) : "user");
    el.innerHTML = `
      <div><strong>${name}</strong></div>
      <div class="small-muted">id: ${u.id || "?"}</div>
    `;
  }

  function setupTabs() {
    const btns = document.querySelectorAll(".tab-btn");
    btns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        const target = $("tab-" + tab);
        if (target) target.classList.add("active");
      });
    });
  }

  async function bootstrapAccess() {
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      appState.initData = tg.initData || "";
      appState.user = tg.initDataUnsafe && tg.initDataUnsafe.user
        ? tg.initDataUnsafe.user
        : null;
      try {
        tg.ready();
      } catch (e) {}
    }

    setUserInfo();

    let userPayload = { user_id: null, username: null };
    if (appState.user) {
      userPayload.user_id = appState.user.id;
      userPayload.username = appState.user.username || "";
    }

    try {
      const res = await apiFetch("/check_access", {
        method: "POST",
        body: userPayload,
      });
      appState.accessGranted = !!res.access_granted;
      appState.isAdmin = !!res.is_admin;
    } catch (e) {
      console.error(e);
      appState.accessGranted = false;
      appState.isAdmin = false;
    }

    if (!appState.accessGranted) {
      document.body.innerHTML = `
        <div class="app">
          <div class="access-denied">
            Доступ к миниаппу закрыт.<br/>
            Обратись к администратору для добавления username.
          </div>
        </div>
      `;
      return;
    }

    if (appState.isAdmin) {
      $("tab-btn-settings").style.display = "";
    } else {
      $("tab-btn-settings").style.display = "none";
    }

    await Promise.all([
      loadJobs(),
      loadArchive(),
      loadGroups(),
    ]);

    if (appState.isAdmin) {
      await Promise.all([
        loadAllowedUsers(),
        loadSecretsOverview(),
      ]);
    }
  }

  async function loadJobs() {
    try {
      const res = await apiFetch("/api/jobs?limit=50&archived=false");
      const jobs = res.jobs || [];
      $("jobs-count").textContent = jobs.length ? `(${jobs.length})` : "";
      const list = $("jobs-list");
      list.innerHTML = "";
      jobs.forEach((j) => {
        const card = renderJobCard(j, false);
        list.appendChild(card);
      });
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки вакансий: " + e.message, true);
    }
  }

  async function loadArchive() {
    try {
      const res = await apiFetch("/api/jobs?limit=50&archived=true");
      const jobs = res.jobs || [];
      $("archive-count").textContent = jobs.length ? `(${jobs.length})` : "";
      const list = $("archive-list");
      list.innerHTML = "";
      jobs.forEach((j) => {
        const card = renderJobCard(j, true);
        list.appendChild(card);
      });
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки архива: " + e.message, true);
    }
  }

  function renderJobCard(job, archived) {
    const card = document.createElement("div");
    card.className = "card";

    const header = document.createElement("div");
    header.className = "job-header";

    const src = document.createElement("div");
    src.className = "job-source";

    const sourceName = job.source_name || job.source || "";
    const srcLabel = document.createElement("span");
    srcLabel.innerHTML = `<strong>${sourceName}</strong>`;
    src.appendChild(srcLabel);

    if (job.source === "tg") {
      const tgSpan = document.createElement("span");
      tgSpan.textContent = "Telegram";
      tgSpan.className = "pill";
      src.appendChild(tgSpan);
    } else if (job.source === "fb") {
      const fbSpan = document.createElement("span");
      fbSpan.textContent = "Facebook";
      fbSpan.className = "pill";
      src.appendChild(fbSpan);
    }

    header.appendChild(src);

    const meta = document.createElement("div");
    meta.className = "job-meta";
    const created = job.created_at ? new Date(job.created_at) : null;
    const received = job.received_at ? new Date(job.received_at) : null;
    let text = "";
    if (created) text += created.toLocaleString("ru-RU");
    if (received) text += (text ? " · " : "") + "получено " + received.toLocaleTimeString("ru-RU");
    meta.textContent = text;
    header.appendChild(meta);

    card.appendChild(header);

    const body = document.createElement("div");
    body.className = "job-text";
    body.textContent = job.text || "";
    card.appendChild(body);

    const linksRow = document.createElement("div");
    linksRow.className = "job-links";

    if (job.url) {
      const a = document.createElement("a");
      a.className = "link-pill";
      a.href = job.url;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.innerHTML = `<span class="label">Группа:</span> <span>${job.source_name || "перейти"}</span>`;
      linksRow.appendChild(a);
    }

    if (job.sender_username) {
      const uname = job.sender_username.replace(/^@/, "");
      const profileUrl = job.source === "tg"
        ? `https://t.me/${uname}`
        : (job.url || "#");
      const a = document.createElement("a");
      a.className = "link-pill";
      a.href = profileUrl;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.innerHTML = `<span class="label">Автор:</span> <span>@${uname}</span>`;
      linksRow.appendChild(a);
    }

    if (linksRow.children.length) {
      card.appendChild(linksRow);
    }

    const actions = document.createElement("div");
    actions.className = "btn-group-row";

    const btn = document.createElement("button");
    btn.className = "btn btn-sm btn-secondary";
    if (!archived) {
      btn.textContent = "В архив";
      btn.addEventListener("click", async () => {
        try {
          await apiFetch(`/api/jobs/${job.id}/archive`, {
            method: "POST",
            admin: true,
            body: { archived: true },
          });
          showFlash("Вакансия отправлена в архив");
          await loadJobs();
          await loadArchive();
        } catch (e) {
          console.error(e);
          showFlash("Не удалось архивировать: " + e.message, true);
        }
      });
    } else {
      btn.textContent = "Вернуть из архива";
      btn.addEventListener("click", async () => {
        try {
          await apiFetch(`/api/jobs/${job.id}/archive`, {
            method: "POST",
            admin: true,
            body: { archived: false },
          });
          showFlash("Вакансия возвращена");
          await loadJobs();
          await loadArchive();
        } catch (e) {
          console.error(e);
          showFlash("Не удалось вернуть: " + e.message, true);
        }
      });
    }
    actions.appendChild(btn);

    card.appendChild(actions);

    return card;
  }

  async function loadGroups() {
    try {
      const res = await apiFetch("/api/groups");
      const groups = res.groups || [];
      const list = $("groups-list");
      list.innerHTML = "";
      if (!groups.length) {
        const div = document.createElement("div");
        div.className = "small-muted";
        div.textContent = "Групп пока нет.";
        list.appendChild(div);
        return;
      }

      groups.forEach((g) => {
        const card = document.createElement("div");
        card.className = "card";

        const body = document.createElement("div");
        body.className = "group-card";

        const header = document.createElement("div");
        header.className = "group-header";

        const title = document.createElement("div");
        title.className = "group-title";

        const linkText = g.group_name || g.group_id || "Группа";
        const a = document.createElement("a");
        const href = (g.group_id || "").startsWith("http")
          ? g.group_id
          : g.group_id
            ? `https://facebook.com/groups/${g.group_id}`
            : "#";

        a.href = href;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = `Группа: ${linkText}`;
        title.appendChild(a);

        const idLine = document.createElement("div");
        idLine.className = "small-muted";
        idLine.textContent = g.group_id || "";
        title.appendChild(idLine);

        header.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "group-meta";

        const pill = document.createElement("span");
        pill.className = "status-pill " + (g.enabled ? "on" : "off");
        pill.textContent = g.enabled ? "включено" : "выключено";
        meta.appendChild(pill);

        header.appendChild(meta);
        body.appendChild(header);

        const actions = document.createElement("div");
        actions.className = "group-actions";

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "btn btn-secondary btn-sm";
        toggleBtn.textContent = g.enabled ? "Выключить" : "Включить";
        toggleBtn.addEventListener("click", async () => {
          try {
            await apiFetch(`/api/groups/${g.id}/toggle`, {
              method: "POST",
              admin: true,
              body: { enabled: !g.enabled },
            });
            await loadGroups();
          } catch (e) {
            console.error(e);
            showFlash("Ошибка изменения статуса группы: " + e.message, true);
          }
        });
        actions.appendChild(toggleBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-danger btn-sm";
        delBtn.textContent = "Удалить";
        delBtn.addEventListener("click", async () => {
          if (!confirm("Удалить эту группу?")) return;
          try {
            await apiFetch(`/api/groups/${g.id}`, {
              method: "DELETE",
              admin: true,
            });
            await loadGroups();
          } catch (e) {
            console.error(e);
            showFlash("Ошибка удаления группы: " + e.message, true);
          }
        });
        actions.appendChild(delBtn);

        body.appendChild(actions);
        card.appendChild(body);
        list.appendChild(card);
      });
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки групп: " + e.message, true);
    }
  }

  async function addGroup() {
    const groupId = $("group-id-input").value.trim();
    const groupName = $("group-name-input").value.trim();
    if (!groupId) {
      showFlash("Укажи ссылку или ID группы", true);
      return;
    }
    try {
      await apiFetch("/api/groups", {
        method: "POST",
        admin: true,
        body: { group_id: groupId, group_name: groupName },
      });
      $("group-id-input").value = "";
      $("group-name-input").value = "";
      await loadGroups();
      showFlash("Группа сохранена");
    } catch (e) {
      console.error(e);
      showFlash("Не удалось сохранить группу: " + e.message, true);
    }
  }

  async function saveFbCookiesJson() {
    const txt = $("fb-cookies-json-input").value.trim();
    if (!txt) {
      showFlash("Вставь JSON cookies", true);
      return;
    }
    try {
      await apiFetch("/api/admin/fb_cookies", {
        method: "POST",
        admin: true,
        body: { cookies_json: txt },
      });
      showFlash("FB cookies JSON сохранён");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка сохранения FB cookies JSON: " + e.message, true);
    }
  }

  async function saveFbCookiesDynamic() {
    const parts = [];
    const xs = $("fb-xs").value.trim();
    const sb = $("fb-sb").value.trim();
    const fr = $("fb-fr").value.trim();
    const c_user = $("fb-c_user").value.trim();
    const datr = $("fb-datr").value.trim();
    const spin = $("fb-spin").value.trim();
    const extra = $("fb-extra-kv").value.trim();

    if (xs) parts.push(`xs=${xs}`);
    if (sb) parts.push(`sb=${sb}`);
    if (fr) parts.push(`fr=${fr}`);
    if (c_user) parts.push(`c_user=${c_user}`);
    if (datr) parts.push(`datr=${datr}`);
    if (spin) parts.push(`spin=${spin}`);
    if (extra) {
      // extra может быть в виде k=v; k2=v2
      extra.split(";").forEach((chunk) => {
        const p = chunk.trim();
        if (!p) return;
        parts.push(p);
      });
    }

    if (!parts.length) {
      showFlash("Заполни xs/sb/fr/c_user или extra", true);
      return;
    }

    const cookieKv = parts.join("; ");

    try {
      await apiFetch("/api/admin/fb_cookies_dynamic", {
        method: "POST",
        admin: true,
        body: { cookie_kv: cookieKv },
      });
      showFlash("Динамичные FB cookies обновлены");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка обновления динамичных FB cookies: " + e.message, true);
    }
  }

  async function loadAllowedUsers() {
    try {
      const res = await apiFetch("/api/allowed_users", { admin: true });
      const users = res.users || [];
      const list = $("allowed-users-list");
      list.innerHTML = "";
      if (!users.length) {
        const div = document.createElement("div");
        div.className = "small-muted";
        div.textContent = "Пока нет дополнительных пользователей.";
        list.appendChild(div);
        return;
      }

      users.forEach((u) => {
        const card = document.createElement("div");
        card.className = "card";
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.alignItems = "center";
        row.style.gap = "6px";

        const info = document.createElement("div");
        info.style.fontSize = "12px";
        info.style.wordBreak = "break-word";
        const name = u.username || "";
        const line1 = document.createElement("div");
        line1.textContent = name;
        const line2 = document.createElement("div");
        line2.className = "small-muted";
        line2.textContent = "id: " + (u.user_id || "—");
        info.appendChild(line1);
        info.appendChild(line2);

        row.appendChild(info);

        const btn = document.createElement("button");
        btn.className = "btn btn-danger btn-sm";
        btn.textContent = "Удалить";
        btn.addEventListener("click", async () => {
          if (!confirm("Удалить пользователя из списка доступа?")) return;
          try {
            await apiFetch(`/api/allowed_users/${u.id}`, {
              method: "DELETE",
              admin: true,
            });
            await loadAllowedUsers();
          } catch (e) {
            console.error(e);
            showFlash("Ошибка удаления пользователя: " + e.message, true);
          }
        });
        row.appendChild(btn);

        card.appendChild(row);
        list.appendChild(card);
      });
    } catch (e) {
      console.error(e);
      showFlash("Ошибка загрузки списка доступа: " + e.message, true);
    }
  }

  async function addAllowedUser() {
    const username = $("allowed-username-input").value.trim().replace(/^@/, "");
    if (!username) {
      showFlash("Укажи username", true);
      return;
    }
    try {
      await apiFetch("/api/allowed_users", {
        method: "POST",
        admin: true,
        body: { username },
      });
      $("allowed-username-input").value = "";
      await loadAllowedUsers();
      showFlash("Пользователь добавлен");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка добавления пользователя: " + e.message, true);
    }
  }

  async function tgAuthStart() {
    const phone = $("tg-phone-input").value.trim();
    if (!phone) {
      showFlash("Введи телефон для Telegram", true);
      return;
    }
    try {
      await apiFetch("/api/admin/tg_auth/start", {
        method: "POST",
        admin: true,
        body: { phone },
      });
      $("tg-auth-hint").textContent = "Код отправлен. Проверь Telegram / SMS.";
      showFlash("Запрос кода отправлен");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка отправки кода: " + e.message, true);
    }
  }

  async function tgAuthConfirm() {
    const phone = $("tg-phone-input").value.trim();
    const code = $("tg-code-input").value.trim();
    const password = $("tg-password-input").value.trim() || null;

    if (!phone) {
      showFlash("Введи телефон", true);
      return;
    }
    if (!code) {
      showFlash("Введи код из Telegram", true);
      return;
    }

    try {
      await apiFetch("/api/admin/tg_auth/confirm", {
        method: "POST",
        admin: true,
        body: { phone, code, password },
      });
      showFlash("Telegram StringSession успешно создана и сохранена");
      $("tg-auth-hint").textContent = "";
      $("tg-code-input").value = "";
      $("tg-password-input").value = "";
    } catch (e) {
      console.error(e);
      showFlash("Ошибка подтверждения кода: " + e.message, true);
    }
  }

  async function tgSaveSessionManual() {
    const session = $("tg-session-manual-input").value.trim();
    if (!session) {
      showFlash("Вставь StringSession", true);
      return;
    }
    try {
      await apiFetch("/api/admin/tg_session", {
        method: "POST",
        admin: true,
        body: { session },
      });
      showFlash("StringSession сохранена");
    } catch (e) {
      console.error(e);
      showFlash("Ошибка сохранения StringSession: " + e.message, true);
    }
  }

  async function tgCheckSession() {
    try {
      const res = await apiFetch("/api/admin/tg_session/check", { admin: true });
      const el = $("tg-check-session-result");
      if (!res.ok) {
        el.textContent = "Сессия неактивна: " + (res.reason || "unknown");
        el.style.color = "#fecaca";
      } else {
        const me = res.me || {};
        const uname = me.username ? `@${me.username}` : (me.first_name || "аккаунт");
        el.textContent = "Сессия активна: " + uname;
        el.style.color = "#bbf7d0";
      }
    } catch (e) {
      console.error(e);
      showFlash("Ошибка проверки сессии: " + e.message, true);
    }
  }

  async function loadSecretsOverview() {
    try {
      const res = await apiFetch("/api/admin/secrets", { admin: true });
      const el = $("secrets-overview");
      const fb = res.fb_cookies_updated_at
        ? new Date(res.fb_cookies_updated_at).toLocaleString("ru-RU")
        : "—";
      const tg = res.tg_session_updated_at
        ? new Date(res.tg_session_updated_at).toLocaleString("ru-RU")
        : "—";
      const pending = res.tg_auth_pending;

      el.innerHTML = `
        <div>FB cookies обновлены: <strong>${fb}</strong></div>
        <div>TG сессия обновлена: <strong>${tg}</strong></div>
        ${
          pending
            ? `<div class="small-muted" style="margin-top:4px;">Незавершённая авторизация: ${JSON.stringify(
                pending
              )}</div>`
            : ""
        }
      `;
    } catch (e) {
      console.error(e);
      $("secrets-overview").textContent = "Ошибка загрузки статусов.";
    }
  }

  function initEvents() {
    $("btn-reload-jobs").addEventListener("click", loadJobs);
    $("btn-reload-archive").addEventListener("click", loadArchive);
    $("btn-add-group").addEventListener("click", addGroup);

    $("btn-save-fb-cookies-json").addEventListener("click", saveFbCookiesJson);
    $("btn-save-fb-cookies-dynamic").addEventListener("click", saveFbCookiesDynamic);

    $("btn-add-allowed-user").addEventListener("click", addAllowedUser);

    $("tg-send-code-btn").addEventListener("click", tgAuthStart);
    $("tg-confirm-code-btn").addEventListener("click", tgAuthConfirm);
    $("tg-save-session-manual-btn").addEventListener("click", tgSaveSessionManual);
    $("tg-check-session-btn").addEventListener("click", tgCheckSession);
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupTabs();
    initEvents();
    bootstrapAccess();
  });
</script>
</body>
</html>
