<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вакансии</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
        }

        header {
            background: #fff;
            padding: 10px 0;
            text-align: center;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
        }

        header p {
            margin: 4px 0 0 0;
            font-size: 12px;
            color: #666;
        }

        #settings-gear {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.75;
            user-select: none;
        }

        nav {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #ddd;
        }

        nav button {
            flex: 1;
            padding: 10px;
            border: none;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        nav button.active {
            border-bottom: 3px solid #0088cc;
            font-weight: bold;
        }

        .container {
            padding: 20px;
        }

        .job {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .job-source {
            font-size: 12px;
            color: #555;
            margin-bottom: 4px;
        }

        .job-created {
            font-size: 11px;
            color: #999;
            margin-bottom: 8px;
        }

        .job-text {
            font-size: 14px;
            margin-bottom: 8px;
            white-space: pre-wrap;
        }

        .job-link a {
            font-size: 13px;
            color: #0088cc;
            text-decoration: none;
        }

        .job-link a:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }

        .group-row {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-url-input {
            width: 75%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 13px;
        }

        .group-enable-btn {
            padding: 8px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            background: #0088cc;
            color: #fff;
        }

        .tg-admin-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .tg-admin-row input {
            flex: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .tg-admin-row button {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            background: #0088cc;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
        }
    </style>

</head>
<body>

<header>
    <h1>Поиск вакансий</h1>
    <p>Сбор вакансий из Telegram и Facebook</p>

    <!-- ШЕСТЕРЁНКА ДЛЯ НАСТРОЕК -->
    <div id="settings-gear" onclick="switchTab('settings')" title="Настройки">
        ⚙️
    </div>
</header>

<nav>
    <button class="tab active" id="jobs-tab-btn" onclick="switchTab('jobs')">Активные вакансии</button>
    <button class="tab" id="archive-tab-btn" onclick="switchTab('archive')">Архив</button>
    <button class="tab" id="channels-tab-btn" onclick="switchTab('channels')">Telegram</button>
    <button class="tab" id="fbgroups-tab-btn" onclick="switchTab('fbgroups')">Facebook</button>

    <!-- Вкладка Настройки (скрывается для юзеров) -->
    <button class="tab" id="settings-tab-btn" onclick="switchTab('settings')">Настройки</button>
</nav>

<div class="container">

    <!-- TAB 1 — АКТИВНЫЕ ВАКАНСИИ -->
    <div id="jobs-tab">
        <div id="jobs-list"></div>
    </div>

    <!-- TAB 2 — АРХИВ -->
    <div id="archive-tab" class="hidden">
        <div id="archive-list"></div>
    </div>

    <!-- TAB 3 — ТЕЛЕГРАМ-КАНАЛЫ -->
    <div id="channels-tab" class="hidden">
        <h3>Telegram каналы</h3>

        <div id="channels-list"></div>

        <div class="tg-admin-row">
            <input type="text" id="new-channel" placeholder="https://t.me/...">
            <button onclick="addChannel()">Добавить</button>
        </div>
    </div>

    <!-- TAB 4 — FACEBOOK ГРУППЫ -->
    <div id="fbgroups-tab" class="hidden">
        <h3>Facebook группы</h3>

        <div id="fb-groups-list"></div>

        <div class="tg-admin-row">
            <input type="text" id="new-fb-group" placeholder="https://www.facebook.com/groups/...">
            <button onclick="addFbGroup()">Добавить</button>
        </div>
    </div>

    <!-- TAB 5 — НАСТРОЙКИ -->
    <div id="settings-tab" class="hidden">
        <h3>Управление доступом</h3>

        <div id="admin-list"></div>

        <div class="tg-admin-row">
            <input type="text" id="new-admin" placeholder="Telegram ID пользователя">
            <button onclick="addAdmin()">Добавить</button>
        </div>

    </div>

</div>

<script>
const API_BASE = window.location.origin;

// ----------------------
// ПЕРЕКЛЮЧЕНИЕ ВКЛАДОК
// ----------------------
function switchTab(tab) {
    document.querySelectorAll(".tab").forEach(btn => btn.classList.remove("active"));
    document.querySelectorAll(".container > div").forEach(div => div.classList.add("hidden"));

    document.getElementById(`${tab}-tab-btn`).classList.add("active");
    document.getElementById(`${tab}-tab`).classList.remove("hidden");

    if (tab === "jobs") loadJobs();
    if (tab === "archive") loadArchive();
    if (tab === "channels") loadChannels();
    if (tab === "fbgroups") loadFbGroups();
    if (tab === "settings") loadAdmins();
}

// ----------------------
// ПРОВЕРКА ДОСТУПА
// ----------------------
async function initApp() {
    const res = await fetch(`${API_BASE}/api/check_access`, {method: "POST"});
    const data = await res.json();

    const isAdmin = data.is_admin;

    const settingsTabBtn = document.getElementById("settings-tab-btn");
    const settingsTabDiv = document.getElementById("settings-tab");
    const settingsGear = document.getElementById("settings-gear");

    if (!isAdmin) {
        if (settingsTabBtn) settingsTabBtn.style.display = "none";
        if (settingsTabDiv) settingsTabDiv.style.display = "none";
        if (settingsGear) settingsGear.style.display = "none";
    }

    loadJobs();
}

// ----------------------
// ВАКАНСИИ
// ----------------------
async function loadJobs() {
    const res = await fetch(`${API_BASE}/api/jobs?limit=50`);
    if (!res.ok) {
        console.error("Ошибка загрузки вакансий", res.status);
        return;
    }
    const data = await res.json();
    const jobs = data.jobs || [];

    const list = document.getElementById("jobs-list");
    list.innerHTML = "";

    if (!jobs.length) {
        list.innerHTML = "<p>Пока нет активных вакансий.</p>";
        return;
    }

    jobs.forEach(job => {
        const text = job.text || "";
        const url = job.url || "";
        const source = job.source_name || job.source || "";
        const created = job.created_at || "";
        list.innerHTML += `
            <div class="job">
                <div class="job-source">${source}</div>
                <div class="job-created">${created}</div>
                <div class="job-text">${text.replace(/\\n/g, "<br>")}</div>
                ${url ? `<div class="job-link"><a href="${url}" target="_blank">Ссылка</a></div>` : ""}
            </div>
        `;
    });
}

// ----------------------
// АРХИВ
// ----------------------
async function loadArchive() {
    const res = await fetch(`${API_BASE}/api/jobs/archive?limit=50`);
    if (!res.ok) {
        console.error("Ошибка загрузки архива вакансий", res.status);
        return;
    }

    const data = await res.json();
    const jobs = data.jobs || [];
    const list = document.getElementById("archive-list");
    list.innerHTML = "";

    if (!jobs.length) {
        list.innerHTML = "<p>Пока нет вакансий в архиве.</p>";
        return;
    }

    jobs.forEach(job => {
        const text = job.text || "";
        const url = job.url || "";
        const source = job.source_name || job.source || "";
        const created = job.created_at || "";
        list.innerHTML += `
            <div class="job">
                <div class="job-source">${source}</div>
                <div class="job-created">${created}</div>
                <div class="job-text">${text.replace(/\\n/g, "<br>")}</div>
                ${url ? `<div class="job-link"><a href="${url}" target="_blank">Ссылка</a></div>` : ""}
            </div>
        `;
    });
}

// ----------------------
// TELEGRAM-КАНАЛЫ
// ----------------------
async function loadChannels() {
    const res = await fetch(`${API_BASE}/api/channels`);
    if (!res.ok) {
        console.error("Ошибка загрузки каналов", res.status);
        return;
    }
    const data = await res.json();
    const channels = data.channels || [];

    const list = document.getElementById("channels-list");
    list.innerHTML = "";

    channels.forEach(ch => {
        const username = ch.username || ch.group_id || "";
        list.innerHTML += `
            <div class="group-row">
                <input class="group-url-input" value="${username}" readonly>
                <button class="group-enable-btn" onclick="toggleChannel('${username}', ${ch.enabled ? "false" : "true"})">
                    ${ch.enabled ? "Отключить" : "Включить"}
                </button>
            </div>
        `;
    });
}

async function toggleChannel(username, enabled) {
    await fetch(`${API_BASE}/api/source/toggle`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({group_id: username, enabled})
    });
    loadChannels();
}

async function addChannel() {
    const url = document.getElementById("new-channel").value.trim();
    if (!url) return;

    await fetch(`${API_BASE}/api/source`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({group_id: url, group_name: url})
    });

    document.getElementById("new-channel").value = "";
    loadChannels();
}

// ----------------------
// FACEBOOK ГРУППЫ
// ----------------------
async function loadFbGroups() {
    const res = await fetch(`${API_BASE}/api/fb_groups`);
    if (!res.ok) {
        console.error("Ошибка загрузки FB-групп", res.status);
        return;
    }
    const data = await res.json();
    const groups = data.groups || [];

    const list = document.getElementById("fb-groups-list");
    list.innerHTML = "";

    groups.forEach(g => {
        const url = g.group_url || g.group_id || "";
        list.innerHTML += `
            <div class="group-row">
                <input class="group-url-input" value="${url}" readonly>
                <button class="group-enable-btn" onclick="toggleFbGroup('${url}', ${g.enabled ? "false" : "true"})">
                    ${g.enabled ? "Отключить" : "Включить"}
                </button>
            </div>
        `;
    });
}

async function toggleFbGroup(url, enabled) {
    await fetch(`${API_BASE}/api/source/toggle`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({group_id: url, enabled})
    });
    loadFbGroups();
}

async function addFbGroup() {
    const url = document.getElementById("new-fb-group").value.trim();
    if (!url) return;

    await fetch(`${API_BASE}/api/source`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({group_id: url, group_name: url})
    });

    document.getElementById("new-fb-group").value = "";
    loadFbGroups();
}

// ----------------------
// АДМИНЫ
// ----------------------
async function loadAdmins() {
    const res = await fetch(`${API_BASE}/api/admins`);
    const admins = await res.json();

    const list = document.getElementById("admin-list");
    list.innerHTML = "";

    admins.forEach(a => {
        list.innerHTML += `
            <div class="group-row">
                <div>${a.user_id}</div>
                <button onclick="removeAdmin(${a.id})">Удалить</button>
            </div>
        `;
    });
}

async function addAdmin() {
    const id = document.getElementById("new-admin").value.trim();
    if (!id) return;

    await fetch(`${API_BASE}/api/admins`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({user_id: id})
    });

    document.getElementById("new-admin").value = "";
    loadAdmins();
}

async function removeAdmin(id) {
    await fetch(`${API_BASE}/api/admins/${id}`, {method: "DELETE"});
    loadAdmins();
}

// ----------------------
initApp();
</script>

</body>
</html>
